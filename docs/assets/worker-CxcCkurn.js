(function(){"use strict";function w(e){return Math.floor(e)===e}function m(e){var r={times:1,num:0};if(w(e))return r.num=e,r;var t=e+"",s=t.indexOf("."),f=t.substr(s+1).length,a=Math.pow(10,f),n=parseInt(e*a+.5,10);return r.times=a,r.num=n,r}function h(e,r,t){var s=m(e),f=m(r),a=s.num,n=f.num,c=s.times,i=f.times,l=c>i?c:i,u=null;switch(t){case"add":return c===i?u=a+n:c>i?u=a+n*(c/i):u=a*(i/c)+n,u/l;case"subtract":return c===i?u=a-n:c>i?u=a-n*(c/i):u=a*(i/c)-n,u/l;case"multiply":return u=a*n/(c*i),u;case"divide":return u=a/n*(i/c),u}}function D(e,r){if(typeof e!="number"||typeof r!="number")throw new Error("args error");return h(e,r,"add")}function p(e,r){if(typeof e!="number"||typeof r!="number")throw new Error("args error");return h(e,r,"subtract")}function P(e,r){if(typeof e!="number"||typeof r!="number")throw new Error("args error");return h(e,r,"multiply")}function b(e,r){if(typeof e!="number"||typeof r!="number")throw new Error("args error");return h(e,r,"divide")}var d={add:D,subtract:p,multiply:P,divide:b};let g=0;function M(e,r,t={}){let s;const f=t.direction==="vertical"?"height":"width";for(let a=Math.max(1,t.startSearchSize??1);a<=(t.maxSearchSize||Math.min(e[f],r[f]));a++){const n=x(e,r,a,t);if(s)s.matchPerc<n.matchPerc&&(s={...n,offset:a});else{s={...n,offset:a};continue}const c=Date.now();c>g+1e3&&(g=c,self.postMessage({code:"progress",data:t._progressCompleteLine}),t._progressCompleteLine=0)}return s}function x(e,r,t,s={}){const f=[];for(let n=0;n<t;n++)if(s.direction==="vertical"){let c=0,i=0;s.sort==="desc"?(c=e.width*(e.height-t+n),i=r.width*n):(c=e.width*n,i=r.width*(r.height-t+n));const l=[],u=[];for(let o=0;o<e.width;o++)l.push([e.imageData[(c+o)*4],e.imageData[(c+o)*4+1],e.imageData[(c+o)*4+2],e.imageData[(c+o)*4+3]]),u.push([r.imageData[(i+o)*4],r.imageData[(i+o)*4+1],r.imageData[(i+o)*4+2],r.imageData[(i+o)*4+3]]);f.push(S(l,u,s))}const{matchPerc:a}=v(f);return{matchPerc:a}}function S(e,r,t={}){const s=e.map((a,n)=>G(e[n],r[n],t)),{matchPerc:f}=v(s);return t._progressCompleteLine++,{matchPerc:f}}function y(e,r,t){return e*6966+r*23436+t*2366>>15}function G(e,r,t={pointDiffType:"gray"}){if(t.pointDiffType==="rgb"){const s=(e[0]+r[0])/2,f=e[0]-r[0],a=e[1]-r[1],n=e[2]-r[2],c=Math.sqrt((2+s/256)*f**2+4*a**2+(2+(255-s)/256)*n**2);return{colorDistance:c,matchPerc:d.subtract(100,Number((c/764*100).toFixed(2)))}}if(t.pointDiffType==="gray"){const s=y(...e),f=y(...r),a=d.subtract(100,Number((Math.abs(s-f)/255*100).toFixed()));return t.isUseGrayWeight?t.isUseGrayWeightReverse?{matchPerc:a*.9+(s<t.SetGrayWeightBoundary?10:0)}:{matchPerc:a*.9+(s>t.SetGrayWeightBoundary?10:0)}:{matchPerc:a}}if(t.pointDiffType==="otsu")return{matchPerc:e[4]===r[4]?100:0}}function v(e){const r=e.reduce((t,s)=>d.add(t,s.matchPerc),0);return{matchPerc:Number((r/(100*e.length)*100).toFixed(2))}}self.addEventListener("message",function(e){const r=e.data;switch(r.cmd){case"getMaxMatchOffset":{const t=r.data.options;t._progressCompleteLine=0,self.postMessage({code:"result",data:M(r.data.image1,r.data.image2,t)});break}default:self.postMessage({code:"Unknow Cmd: "+r.cmd})}},!1)})();
