import{P as G}from"./95227df1.js";import{I as C}from"./62d9ce5f.js";import{M as D}from"./f08d8d18.js";import{_ as T,u as $,ay as b,a0 as F,aN as R,aL as _,aO as L,b as p,d as N,e as O,p as f,w,h as y,l as W}from"./assets/index-207a969d.js";import{P as M}from"./8e0cd143.js";const V=[],x=[];function z(t){let e=V.find(r=>r.WorkerConstructor===t&&!r.running);return!e&&V.length<navigator.hardwareConcurrency-1&&(e={WorkerConstructor:t,worker:new t,running:!1},V.push(e)),e}function I(){if(x.length>0){const t=z(x[0].WorkerConstructor);if(t){const e=x.shift(),r=t.worker;t.running=!0,r.onmessage=function(i){switch(i.data.code){case"result":{e.resolve(i.data.data),t.running=!1,I();break}case"progress":{e.args.progress&&e.args.progress(i.data.data);break}default:e.reject("Unknow Result Code: "+i.data.code)}};const m={...e.args};delete m.progress,r.postMessage(m)}}}function E(t,e){return new Promise((r,m)=>{x.push({WorkerConstructor:t,resolve:r,reject:m,args:e}),I()})}function A(){return new Worker("/assets/worker-4da5cc7c.js")}async function S(t,e){return new Promise((r,m)=>{const i=document.createElement("canvas"),l=i.getContext("2d"),o=new Image;o.onload=async()=>{try{i.width=o.width*e.zoom,i.height=o.height*e.zoom,l.drawImage(o,0,0,o.width,o.height,0,0,i.width,i.height);const u=l.getImageData(0,0,i.width,i.height).data;r({height:i.height,width:i.width,imageData:u})}catch(u){m(u)}},o.src=t instanceof File?URL.createObjectURL(t):t})}function j(t,e,r){return t*6966+e*23436+r*2366>>15}function U(t,e,r,m,i=[]){const{imageData:l,width:o,height:u}=e,[d=0,g=m==="vertical"?u:o]=i;if(m==="vertical")for(let a=d*o;a<g*o;a++){const n=a*4,c=[l[n],l[n+1],l[n+2],l[n+3]];t.fillStyle=`rgba(${c.join(",")})`,t.fillRect(a%o,r+parseInt(a/o),1,1)}}async function H(t,e={}){e={...e,direction:e.direction??"vertical",pointDiffType:e.pointDiffType??"gray",sort:e.sort??"desc",skipLine:e.skipLine??10,zoom:e.zoom??.5};const r=await Promise.all(t.map(u=>S(u,e)));if(Array.from(new Set(r.map(u=>u[e.direction==="vertical"?"width":"height"]))).length>1)throw new Error(`拼接方向为${e.direction==="vertical"?"纵向":"横向"}时所有图片的${e.direction==="vertical"?"宽度":"长度"}必须一致`);const m=r.slice(0,r.length-1).reduce((u,d,g)=>{const a=e.direction==="vertical"?"height":"width",n=Math.min(d[a],r[g+1][a]),c=n*(1+n)/2;return u+c},0);let i=0,l=0;const o=(await Promise.all(r.slice(0,r.length-1).map((u,d)=>E(A,{cmd:"getMaxMatchOffset",data:{image1:r[d],image2:r[d+1],options:{direction:e.direction,pointDiffType:e.pointDiffType,sort:e.sort,isUseGrayWeight:e.isUseGrayWeight,SetGrayWeightBoundary:e.SetGrayWeightBoundary,isUseGrayWeightReverse:e.isUseGrayWeightReverse}},progress:g=>{if(e.progress){i+=g;const a=Date.now();a>l+1e3&&(l=a,e.progress(Number((i/m*100).toFixed(2))))}}})))).map(u=>u.offset/e.zoom);return e.progress&&e.progress(100),{async render(u){let d=r;e.zoom!==1&&(d=await Promise.all(t.map(a=>S(a,{...e,zoom:1}))));const g=u.getContext("2d");if(e.direction==="vertical"?(u.width=d[0].width,u.height=d.reduce((a,n)=>a+n.height,0)-o.reduce((a,n)=>a+n,0)):(u.width=d.reduce((a,n)=>a+n.width,0)-o.reduce((a,n)=>a+n,0),u.height=d[0].height),e.sort==="desc"){let a=0;for(let n=0;n<o.length;n++){const c=o[n];n===0&&(U(g,d[n],a,e.direction),a=a+d[n].height),a=a-c,U(g,d[n+1],a,e.direction,[c-e.skipLine]),a=a+d[n+1].height}}else{let a=u.height;for(let n=0;n<o.length;n++){const c=o[n];n===0&&(a=a-d[n].height,U(g,d[n],a,e.direction)),a=a-d[n+1].height+c,U(g,d[n+1],a,e.direction,[0,d[n+1][e.direction==="vertical"?"height":"width"]-c+e.skipLine])}}}}}const q={components:{PageHeader:G,ImageCon:C,MediaBrowser:D,PreviewScreenshots:M},setup(){const{isGreatOldOne:t}=$();return{isGreatOldOne:t}},data(){return{progress:0,progressStatus:"",startTime:0,endTime:0,canAutoUpdateEnd:!0,formConfig:{labelPosition:"top"},formData:{},fields:[{type:"radio",prop:"pointDiffType",label:"对比方法",required:!0,defaultValue:()=>"gray",options:()=>[{label:"灰度值(推荐，兼顾速度和准确性)",value:"gray"},{label:"色差(速度较慢)",value:"rgb"}]},{type:"switch",label:"使用在线视频",prop:"isUseOnlineVideo",showInForm:()=>this.isGreatOldOne,defaultValue:()=>!1},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",showInForm:t=>t.formData.isUseOnlineVideo===!0},{type:"slot",slotName:"tsSelector",needAutoUpdateTime:!0,prop:"start",label:"开始时间",afterSlotName:"screenshots",defaultValue:()=>"00:00:00.0",onChange:(t,e,r)=>{r&&this.canAutoUpdateEnd&&(t.formData.end=t.formData.start)},showInForm:t=>t.formData.isUseOnlineVideo===!0},{type:"slot",slotName:"tsSelector",prop:"end",label:"结束时间",afterSlotName:"screenshots",defaultValue:()=>"00:00:00.0",onChange:(t,e,r)=>{r&&(this.canAutoUpdateEnd=!1)},showInForm:t=>t.formData.isUseOnlineVideo===!0},{type:"number",prop:"splitCount",label:"分割数量",formProps:{type:"number",min:2},defaultValue:()=>Math.min(10,Math.max(2,navigator.hardwareConcurrency-1)),showInForm:t=>t.formData.isUseOnlineVideo===!0},{type:"upload",prop:"images",label:"截图",required:!0,formProps:{listType:"picture-card",multiple:!0},defaultValue:()=>[],rules:[{required:!0,trigger:"submit",validator:(t,e,r)=>{e.length>1?r():r("最少需要两张截图")}}],buttons:[{type:"primary",label:"从视频源生成预览图",show:t=>t.formData.isUseOnlineVideo===!0,handler:t=>this.generateScreenshots(t.formData,"jpg")},{type:"primary",label:"从视频源生成原图",show:t=>t.formData.isUseOnlineVideo===!0,handler:t=>this.generateScreenshots(t.formData,"png")}]},{type:"radio",prop:"direction",label:"截图方向",afterSlotName:"direction-example",required:!0,defaultValue:()=>"vertical-desc",options:[{label:"从上到下",value:"vertical-desc"},{label:"从下到上",value:"vertical-asc"},{label:"从左到右(开发中)",value:"horizontal-desc",disabled:!0},{label:"从右到左(开发中)",value:"horizontal-asc",disabled:!0}]},{type:"number",prop:"skipLine",label:"裁剪边缘",tips:"渲染时去除图像边缘的距离，一定程度上可以去除图像边缘颜色变化的影响。",formProps:{type:"number",min:0},defaultValue:()=>10},{type:"switch",prop:"isUseGrayWeight",label:"调整特定灰度值的权重",tips:"增加局部画面的权重，适用于画面背景和主要画像不是同步移动的时候，增加主要画像的匹配权重",defaultValue:()=>!1},{type:"switch",prop:"isUseGrayWeightReverse",label:"取反",showInForm:!1,keepOnForm:t=>t.formData.isUseGrayWeight,defaultValue:()=>!1},{type:"slot",slotName:"SetGrayWeightBoundary",prop:"grayWeightBoundary",label:"灰度值分界点",tips:"调整至主要画像为蓝色即可",showInForm:t=>t.formData.isUseGrayWeight,defaultValue:()=>100},{type:"radio",prop:"zoom",label:"采样率",tips:"采样率越低，效率越高，采样率过低可能会导致结果不准确。",options:[{label:"10%",value:10},{label:"25%",value:25},{label:"50%",value:50},{label:"75%",value:75},{label:"100%",value:100}],defaultValue:()=>50},{type:"view",prop:"text",hiddenLabel:!0,viewer:()=>`可用线程数: ${navigator.hardwareConcurrency}`}],buttons:[{type:"primary",label:"合成",handler:(t,e)=>t.formInstance.submitForm().then(r=>{const[m,i]=r.direction.split("-");return this.startTime=Date.now(),this.endTime=0,this.progress=0,this.progressStatus="",this.$refs.result.width=0,this.$refs.result.height=0,H(r.images.map(l=>l.raw),{direction:m,pointDiffType:r.pointDiffType,sort:i,skipLine:r.skipLine,zoom:b.divide(r.zoom,100),isUseGrayWeight:r.isUseGrayWeight,SetGrayWeightBoundary:r.SetGrayWeightBoundary,isUseGrayWeightReverse:r.isUseGrayWeightReverse,progress:l=>{this.progress=l}}).then(({render:l})=>new Promise(o=>{this.endTime=Date.now(),setTimeout(()=>{o(l(this.$refs.result).then(()=>{this.progressStatus="success"}))},1e3)})).catch(l=>{throw this.progressStatus="exception",F.error(l==null?void 0:l.message),l})})},{type:"success",label:"下载",show:()=>this.progressStatus==="success",handler:(t,e)=>new Promise(r=>{this.$refs.result.toBlob(i=>{R(i,`${this.getMergeFileName(this.formData.images.map(l=>l.raw))}.png`),r()})})}]}},methods:{async previewGrayWeightBoundary(t){if(t.images.length===0){this.$msgBox.warning("请先选择截图");return}const e=await S(t.images[parseInt(t.images.length/2)].file,{zoom:1}),{imageData:r,width:m,height:i}=e,[l]=t.direction.split("-"),[o=0,u=l==="vertical"?i:m]=[],d=this.$refs.SetGrayWeightBoundaryPreview,g=d.getContext("2d");if(d.width=m,d.height=i,l==="vertical")for(let a=o*m;a<u*m;a++){const n=a*4,c=[r[n],r[n+1],r[n+2],r[n+3]];g.fillStyle=`rgba(${c.join(",")})`;const v=j(...c);t.isUseGrayWeightReverse?g.fillStyle=v>t.grayWeightBoundary?"rgba(255,255,255,255)":"rgba(38, 126, 240,255)":g.fillStyle=v>t.grayWeightBoundary?"rgba(38, 126, 240,255)":"rgba(255,255,255,255)",g.fillRect(a%m,parseInt(a/m),1,1)}},getMergeFileName(t){let e="";for(let r=0;r<t[0].name.length&&!t.some(m=>m.name[r]!==t[0].name[r]);r++)e+=t[0].name[r];return`${e}${["-","_"].includes(e[e.length-1])?"":"-"}merge`},async generateScreenshots(t,e){if(!t.sourcePath){this.$msgBox.warning("请先选择视频源");return}if(!t.start){this.$msgBox.warning("请先选择开始时间");return}if(t.end){const o=_(t.end),u=_(t.start);if(o<=u){this.$msgBox.warning(`结束时间[${o}]不能小于等于开始时间[${u}]`);return}}else{this.$msgBox.warning("请先选择结束时间");return}if(t.splitCount<2){this.$msgBox.warning("分割数量必须大于1");return}const r=_(t.start),m=_(t.end),i=b.divide(b.subtract(m,r),t.splitCount-1),l=new Array(t.splitCount-1).fill(null).map((o,u)=>Number(b.add(r,b.multiply(u,i)).toFixed(2)));l.push(m),t.images=[];for(let o=0;o<l.length;o++){const u=l[o],d=await L(t.sourcePath,u,e),g=`image-${o}.${e}`;t.images.push({name:g,raw:new File([d],g,{type:d.type}),status:"ready",percentage:0,size:d.size,url:URL.createObjectURL(d)})}},previewResult(){this.$refs.result.toBlob(t=>{const e=`${this.getMergeFileName(this.formData.images.map(r=>r.raw))}.png`;this.$imagePreview(URL.createObjectURL(t),{fileName:e})})}}},J={class:"page"},K={class:"direction-example"},Q={class:"SetGrayWeightBoundary-handler"},X={ref:"SetGrayWeightBoundaryPreview",style:{width:"100%","margin-top":"24px",cursor:"pointer"}},Y={style:{"margin-top":"24px"}};function Z(t,e,r,m,i,l){const o=p("PageHeader"),u=p("ImageCon"),d=p("MediaBrowser"),g=p("el-time-picker"),a=p("el-input-number"),n=p("PreviewScreenshots"),c=p("el-slider"),v=p("el-switch"),k=p("el-button"),B=p("EasyForm"),P=p("el-progress");return N(),O("div",J,[f(o),f(B,{modelValue:i.formData,"onUpdate:modelValue":e[0]||(e[0]=s=>i.formData=s),fields:i.fields,buttons:i.buttons,"form-config":i.formConfig},{"direction-example":w(s=>[y("div",K,[e[2]||(e[2]=y("span",null,"示例：",-1)),f(u,{source:"static",src:`/assets/image-merge-${s.formData[s.field.prop]}-example.png`},null,8,["src"])])]),fileBrowser:w(s=>[f(d,{modelValue:s.formData[s.field.prop],"onUpdate:modelValue":h=>s.formData[s.field.prop]=h,checkMode:"single"},null,8,["modelValue","onUpdate:modelValue"])]),tsSelector:w(s=>[f(g,{"model-value":s.formData[s.field.prop].split(".")[0],"value-format":"HH:mm:ss",format:"HH:mm:ss",style:{width:"120px"},"onUpdate:modelValue":h=>{s.formData[s.field.prop]=`${h||"00:00:00"}.${s.formData[s.field.prop].split(".")[1]}`,s.field.onChange(s,h,!0)}},null,8,["model-value","onUpdate:modelValue"]),e[3]||(e[3]=y("span",null,".",-1)),f(a,{"model-value":Number("0."+s.formData[s.field.prop].split(".")[1]),min:0,max:1,precision:3,step:.1,style:{width:"120px"},"onUpdate:modelValue":h=>{s.formData[s.field.prop]=`${s.formData[s.field.prop].split(".")[0]}.${String(h).split(".")[1]||0}`,s.field.onChange(s,h,!0)}},null,8,["model-value","onUpdate:modelValue"])]),screenshots:w(s=>[f(n,{modelValue:s.formData[s.field.prop],sourcePath:s.formData.sourcePath,"onUpdate:modelValue":h=>{s.formData[s.field.prop]=h,s.field.onChange(s,h,!0)}},null,8,["modelValue","sourcePath","onUpdate:modelValue"])]),SetGrayWeightBoundary:w(s=>[f(c,{modelValue:s.formData[s.field.prop],"onUpdate:modelValue":h=>s.formData[s.field.prop]=h,"show-input":"",max:255},null,8,["modelValue","onUpdate:modelValue"]),y("div",Q,[e[5]||(e[5]=W(" 取反")),f(v,{modelValue:s.formData.isUseGrayWeightReverse,"onUpdate:modelValue":h=>s.formData.isUseGrayWeightReverse=h,"inline-prompt":"","active-text":"是","inactive-text":"否"},null,8,["modelValue","onUpdate:modelValue"]),f(k,{style:{"margin-left":"auto"},onClick:()=>{l.previewGrayWeightBoundary(s.formData)}},{default:w(()=>e[4]||(e[4]=[W(" 预览 ")])),_:2},1032,["onClick"])]),y("canvas",X,null,512)]),_:1},8,["modelValue","fields","buttons","form-config"]),y("div",Y,[f(P,{percentage:i.progress,"text-inside":!0,"stroke-width":24,status:i.progressStatus,format:s=>!i.progressStatus&&s===100?`成功，用时: ${((i.endTime-i.startTime)/1e3).toFixed(1)}s，canvas渲染结果中`:i.progressStatus==="success"?`成功，用时: ${((i.endTime-i.startTime)/1e3).toFixed(1)}s`:`${s}%`},null,8,["percentage","status","format"]),y("canvas",{ref:"result",style:{width:"100%","margin-top":"24px",cursor:"pointer"},onClick:e[1]||(e[1]=()=>{l.previewResult()})},null,512)])])}const ie=T(q,[["render",Z],["__scopeId","data-v-078ab03a"]]);export{ie as default};
