import{P as O}from"./xDjA66wGt.js";import{aC as j,_ as E,A as N,K as q,aD as C,aE as J,aF as z,a0 as S,aG as R,b as L,z as w,f as h,w as k,l as y,j as I,k as b,F as D,B as V,d as G,t as U,e as H}from"./assets/index-BSexJRP1.js";import{g as T}from"./vander_commonjsHelpers-CqkleIqs.js";var P={exports:{}},W=P.exports,B;function K(){return B||(B=1,function(o,e){(function(r,f){o.exports=f()})(W,function(){function r(n){var i=[];return n.AMapUI&&i.push(f(n.AMapUI)),n.Loca&&i.push(u(n.Loca)),Promise.all(i)}function f(n){return new Promise(function(i,s){var c=[];if(n.plugins)for(var p=0;p<n.plugins.length;p+=1)a.AMapUI.plugins.indexOf(n.plugins[p])==-1&&c.push(n.plugins[p]);if(l.AMapUI===t.failed)s("前次请求 AMapUI 失败");else if(l.AMapUI===t.notload){l.AMapUI=t.loading,a.AMapUI.version=n.version||a.AMapUI.version,p=a.AMapUI.version;var M=document.body||document.head,m=document.createElement("script");m.type="text/javascript",m.src="https://webapi.amap.com/ui/"+p+"/main.js",m.onerror=function(d){l.AMapUI=t.failed,s("请求 AMapUI 失败")},m.onload=function(){if(l.AMapUI=t.loaded,c.length)window.AMapUI.loadUI(c,function(){for(var d=0,A=c.length;d<A;d++){var _=c[d].split("/").slice(-1)[0];window.AMapUI[_]=arguments[d]}for(i();g.AMapUI.length;)g.AMapUI.splice(0,1)[0]()});else for(i();g.AMapUI.length;)g.AMapUI.splice(0,1)[0]()},M.appendChild(m)}else l.AMapUI===t.loaded?n.version&&n.version!==a.AMapUI.version?s("不允许多个版本 AMapUI 混用"):c.length?window.AMapUI.loadUI(c,function(){for(var d=0,A=c.length;d<A;d++){var _=c[d].split("/").slice(-1)[0];window.AMapUI[_]=arguments[d]}i()}):i():n.version&&n.version!==a.AMapUI.version?s("不允许多个版本 AMapUI 混用"):g.AMapUI.push(function(d){d?s(d):c.length?window.AMapUI.loadUI(c,function(){for(var A=0,_=c.length;A<_;A++){var F=c[A].split("/").slice(-1)[0];window.AMapUI[F]=arguments[A]}i()}):i()})})}function u(n){return new Promise(function(i,s){if(l.Loca===t.failed)s("前次请求 Loca 失败");else if(l.Loca===t.notload){l.Loca=t.loading,a.Loca.version=n.version||a.Loca.version;var c=a.Loca.version,p=a.AMap.version.startsWith("2"),M=c.startsWith("2");if(p&&!M||!p&&M)s("JSAPI 与 Loca 版本不对应！！");else{p=a.key,M=document.body||document.head;var m=document.createElement("script");m.type="text/javascript",m.src="https://webapi.amap.com/loca?v="+c+"&key="+p,m.onerror=function(d){l.Loca=t.failed,s("请求 AMapUI 失败")},m.onload=function(){for(l.Loca=t.loaded,i();g.Loca.length;)g.Loca.splice(0,1)[0]()},M.appendChild(m)}}else l.Loca===t.loaded?n.version&&n.version!==a.Loca.version?s("不允许多个版本 Loca 混用"):i():n.version&&n.version!==a.Loca.version?s("不允许多个版本 Loca 混用"):g.Loca.push(function(d){d?s(d):s()})})}if(!window)throw Error("AMap JSAPI can only be used in Browser.");var t;(function(n){n.notload="notload",n.loading="loading",n.loaded="loaded",n.failed="failed"})(t||(t={}));var a={key:"",AMap:{version:"1.4.15",plugins:[]},AMapUI:{version:"1.1",plugins:[]},Loca:{version:"1.3.2"}},l={AMap:t.notload,AMapUI:t.notload,Loca:t.notload},g={AMap:[],AMapUI:[],Loca:[]},v=[],x=function(n){typeof n=="function"&&(l.AMap===t.loaded?n(window.AMap):v.push(n))};return{load:function(n){return new Promise(function(i,s){if(l.AMap==t.failed)s("");else if(l.AMap==t.notload){var c=n.key,p=n.version,M=n.plugins;c?(window.AMap&&location.host!=="lbs.amap.com"&&s("禁止多种API加载方式混用"),a.key=c,a.AMap.version=p||a.AMap.version,a.AMap.plugins=M||a.AMap.plugins,l.AMap=t.loading,p=document.body||document.head,window.___onAPILoaded=function(d){if(delete window.___onAPILoaded,d)l.AMap=t.failed,s(d);else for(l.AMap=t.loaded,r(n).then(function(){i(window.AMap)}).catch(s);v.length;)v.splice(0,1)[0]()},M=document.createElement("script"),M.type="text/javascript",M.src="https://webapi.amap.com/maps?callback=___onAPILoaded&v="+a.AMap.version+"&key="+c+"&plugin="+a.AMap.plugins.join(","),M.onerror=function(d){l.AMap=t.failed,s(d)},p.appendChild(M)):s("请填写key")}else if(l.AMap==t.loaded)if(n.key&&n.key!==a.key)s("多个不一致的 key");else if(n.version&&n.version!==a.AMap.version)s("不允许多个版本 JSAPI 混用");else{if(c=[],n.plugins)for(p=0;p<n.plugins.length;p+=1)a.AMap.plugins.indexOf(n.plugins[p])==-1&&c.push(n.plugins[p]);c.length?window.AMap.plugin(c,function(){r(n).then(function(){i(window.AMap)}).catch(s)}):r(n).then(function(){i(window.AMap)}).catch(s)}else if(n.key&&n.key!==a.key)s("多个不一致的 key");else if(n.version&&n.version!==a.AMap.version)s("不允许多个版本 JSAPI 混用");else{var m=[];if(n.plugins)for(p=0;p<n.plugins.length;p+=1)a.AMap.plugins.indexOf(n.plugins[p])==-1&&m.push(n.plugins[p]);x(function(){m.length?window.AMap.plugin(m,function(){r(n).then(function(){i(window.AMap)}).catch(s)}):r(n).then(function(){i(window.AMap)}).catch(s)})}})},reset:function(){delete window.AMap,delete window.AMapUI,delete window.Loca,a={key:"",AMap:{version:"1.4.15",plugins:[]},AMapUI:{version:"1.1",plugins:[]},Loca:{version:"1.3.2"}},l={AMap:t.notload,AMapUI:t.notload,Loca:t.notload},g={AMap:[],AMapUI:[],Loca:[]}}}})}(P)),P.exports}var $=K();const Q=T($);function X(o,e={}){return new Promise((r,f)=>{o.plugin("AMap.Geolocation",function(){new o.Geolocation({enableHighAccuracy:!0,timeout:1e4,offset:[10,20],zoomToAccuracy:!0,position:"RB",...e}).getCurrentPosition(function(t,a){t==="complete"?r(a):f(a.message)})})})}function Y(o,e,r){return new Promise((f,u)=>{o.convertFrom(e,r,function(t,a){t==="complete"&&a.info==="ok"?f(a.locations):u(a)})})}async function Z(o,e,r){const f=[];let u=!1;for(const t of j(e,40)){u&&await new Promise(l=>{setTimeout(()=>{l()},1e3)}),u=!0;const a=await Y(o,t,r);f.push(...a)}return f}function ee(o,e){function r(v){return v*(Math.PI/180)}const f=6371,u=r(e.lat-o.lat),t=r(e.lng-o.lng),a=Math.sin(u/2)*Math.sin(u/2)+Math.cos(r(o.lat))*Math.cos(r(e.lat))*Math.sin(t/2)*Math.sin(t/2),l=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return f*l}const ne={components:{PageHeader:O,AsyncButtom:N,AsyncSwitch:q},data(){return{security:C(J()),AMap:null,parkingData:[],distance:50,activePark:"",isSwitchSelfMarker:!1}},watch:{async parkingData(){const o=await this.AMap;for(const e of Object.values(this.parkingMarkers||{}))e.remove();this.parkingMarkers={};for(const e of this.parkingData){const r=new o.Marker({position:new o.LngLat(e.lng,e.lat),content:'<img src="/assets/park.png" style="width: 28px;">',offset:[-14,-28],extData:e});r.on("click",f=>{var u,t,a;this.activePark=e.parkId,(a=(t=(u=this.$refs[`collapse-${e.parkId}`])==null?void 0:u[0])==null?void 0:t.scrollIntoView)==null||a.call(t,{behavior:"smooth",block:"center",inline:"center"})}),this.map.add(r),this.parkingMarkers[e.parkId]=r}},activePark(){const o=this.parkingData.find(e=>e.parkId===this.activePark);this.map.setCenter([o.lng,o.lat],!0);for(const e of Object.values(this.parkingMarkers||{}))e.setContent('<img src="/assets/park.png" style="width: 28px;">');this.parkingMarkers[o.parkId].setContent('<img src="/assets/park_active.png" style="width: 28px;">'),o.order||(o.order=z({parkId:o.parkId}).then(e=>{o.order=e}))}},created(){let o=null;this.AMap=C(new Promise(e=>{o=e})),this.security.then(e=>{window._AMapSecurityConfig={securityJsCode:e.amapJsCode},o(Q.load({key:"ad6be402e09782b82c8fc2bd151ca9a9",version:"2.0",plugins:["AMap.Scale"]}))})},beforeUnmount(){var o;(o=this.map)==null||o.destroy()},mounted(){this.AMap.then(o=>{X(o).then(e=>{this.map=new o.Map("map-container",{zoom:12,center:[e.position.lng,e.position.lat]}),this.selfMarker=new o.Marker({content:'<img src="/assets/marker_self.png" style="width: 19px;">',offset:[-9.5,-31],position:new o.LngLat(e.position.lng,e.position.lat)}),this.map.add(this.selfMarker),this.getParking(),this.map.on("click",r=>{this.isSwitchSelfMarker&&this.selfMarker.setPosition([r.lnglat.lng,r.lnglat.lat])})}).catch(e=>{this.map=new o.Map("map-container"),S.warning(e)})})},methods:{async getParking(){const o=this.selfMarker.getPosition();this.parkingData=await R({lng:o.lng,lat:o.lat,distance:this.distance}).then(async e=>{const r=await Z(await this.AMap,e.map(f=>[f.positionX,f.positionY]),"baidu");return e.map((f,u)=>({...f,lng:r[u].lng,lat:r[u].lat,lineDistance:ee(o,{lng:r[u].lng,lat:r[u].lat}).toFixed(2)}))}),this.parkingData.length===0&&S.warning(`范围${this.distance}公里内无可用停车场`)},openOrder(o){window.open(`https://g.qcyuns.com/park-shop/scanQrFixCode?fixCodeId=${o.id}`,"_blank")},gotoAPP(o){window.open(`https://uri.amap.com/marker?position=${o.lng},${o.lat}&coordinate=gaode&callnative=1`,"_blank")}}},te={class:"page"},oe={class:"btn-box"},ae={class:"btn-box"},ie={class:"name"},se={class:"line-distance"},re={class:"remark"},le={key:0,class:"order-list"},ue={class:"shopName"},pe={class:"amount"},ce={class:"btn-box"};function de(o,e,r,f,u,t){const a=I("PageHeader"),l=I("el-input"),g=I("AsyncButtom"),v=I("AsyncSwitch"),x=I("el-collapse-item"),n=I("el-collapse");return b(),L("div",te,[w(a),h("div",oe,[w(l,{modelValue:u.distance,"onUpdate:modelValue":e[0]||(e[0]=i=>u.distance=i)},{append:k(()=>e[3]||(e[3]=[y(" 公里 ")])),_:1},8,["modelValue"]),w(g,{type:"primary",onLoadingClick:()=>t.getParking()},{default:k(()=>e[4]||(e[4]=[y(" 获取当前位置附近停车场 ")])),_:1},8,["onLoadingClick"])]),h("div",ae,[e[5]||(e[5]=y(" 修改当前定位 ")),w(v,{modelValue:u.isSwitchSelfMarker,"onUpdate:modelValue":e[1]||(e[1]=i=>u.isSwitchSelfMarker=i)},null,8,["modelValue"])]),e[8]||(e[8]=h("div",{id:"map-container"},null,-1)),w(n,{modelValue:u.activePark,"onUpdate:modelValue":e[2]||(e[2]=i=>u.activePark=i),accordion:""},{default:k(()=>[(b(!0),L(D,null,V(u.parkingData,i=>(b(),G(x,{key:i.parkId,name:i.parkId},{title:k(()=>[h("div",{ref_for:!0,ref:`collapse-${i.parkId}`,class:"collapse-title"},[h("div",ie,[y(U(i.parkName)+" ",1),h("span",se," 直线距离: "+U(i.lineDistance)+"公里 ",1)])],512)]),default:k(()=>[h("div",re,[y(U(i.remark)+" ",1),w(g,{type:"primary",size:"mini",onLoadingClick:()=>{t.gotoAPP(i)}},{default:k(()=>e[6]||(e[6]=[y(" 导航 ")])),_:2},1032,["onLoadingClick"])]),Array.isArray(i.order)?(b(),L("div",le,[(b(!0),L(D,null,V(i.order,s=>(b(),L("div",{key:s.id,class:"order"},[h("div",ue,U(s.shopName),1),h("div",pe,U(s.amount),1),h("div",ce,[w(g,{type:"primary",size:"mini",onLoadingClick:()=>{t.openOrder(s)}},{default:k(()=>e[7]||(e[7]=[y(" 打开 ")])),_:2},1032,["onLoadingClick"])])]))),128))])):H("",!0)]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"])])}const Me=E(ne,[["render",de],["__scopeId","data-v-8f1f7f54"]]);export{Me as default};
