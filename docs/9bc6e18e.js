import{P as C}from"./ea276899.js";import{I as D}from"./4f7e1f88.js";import{M as T}from"./02d23518.js";import{_ as $,u as F,aw as b,a0 as R,aM as N,aK as _,aN as L,b as p,d as M,e as O,p as f,w,h as y,l as I,a2 as z,a3 as E}from"./assets/index-f6740f98.js";import{P as A}from"./139a45a6.js";const V=[],x=[];function j(e){let t=V.find(r=>r.WorkerConstructor===e&&!r.running);return!t&&V.length<navigator.hardwareConcurrency-1&&(t={WorkerConstructor:e,worker:new e,running:!1},V.push(t)),t}function W(){if(x.length>0){const e=j(x[0].WorkerConstructor);if(e){const t=x.shift(),r=e.worker;e.running=!0,r.onmessage=function(i){switch(i.data.code){case"result":{t.resolve(i.data.data),e.running=!1,W();break}case"progress":{t.args.progress&&t.args.progress(i.data.data);break}default:t.reject("Unknow Result Code: "+i.data.code)}};const c={...t.args};delete c.progress,r.postMessage(c)}}}function H(e,t){return new Promise((r,c)=>{x.push({WorkerConstructor:e,resolve:r,reject:c,args:t}),W()})}function q(){return new Worker("/assets/worker-4da5cc7c.js")}async function S(e,t){return new Promise((r,c)=>{const i=document.createElement("canvas"),l=i.getContext("2d"),o=new Image;o.onload=async()=>{try{i.width=o.width*t.zoom,i.height=o.height*t.zoom,l.drawImage(o,0,0,o.width,o.height,0,0,i.width,i.height);const u=l.getImageData(0,0,i.width,i.height).data;r({height:i.height,width:i.width,imageData:u})}catch(u){c(u)}},o.src=e instanceof File?URL.createObjectURL(e):e})}function K(e,t,r){return e*6966+t*23436+r*2366>>15}function U(e,t,r,c,i=[]){const{imageData:l,width:o,height:u}=t,[d=0,m=c==="vertical"?u:o]=i;if(c==="vertical")for(let a=d*o;a<m*o;a++){const n=a*4,h=[l[n],l[n+1],l[n+2],l[n+3]];e.fillStyle=`rgba(${h.join(",")})`,e.fillRect(a%o,r+parseInt(a/o),1,1)}}async function J(e,t={}){t={...t,direction:t.direction??"vertical",pointDiffType:t.pointDiffType??"gray",sort:t.sort??"desc",skipLine:t.skipLine??10,zoom:t.zoom??.5};const r=await Promise.all(e.map(u=>S(u,t)));if(Array.from(new Set(r.map(u=>u[t.direction==="vertical"?"width":"height"]))).length>1)throw new Error(`拼接方向为${t.direction==="vertical"?"纵向":"横向"}时所有图片的${t.direction==="vertical"?"宽度":"长度"}必须一致`);const c=r.slice(0,r.length-1).reduce((u,d,m)=>{const a=t.direction==="vertical"?"height":"width",n=Math.min(d[a],r[m+1][a]),h=n*(1+n)/2;return u+h},0);let i=0,l=0;const o=(await Promise.all(r.slice(0,r.length-1).map((u,d)=>H(q,{cmd:"getMaxMatchOffset",data:{image1:r[d],image2:r[d+1],options:{direction:t.direction,pointDiffType:t.pointDiffType,sort:t.sort,isUseGrayWeight:t.isUseGrayWeight,SetGrayWeightBoundary:t.SetGrayWeightBoundary,isUseGrayWeightReverse:t.isUseGrayWeightReverse}},progress:m=>{if(t.progress){i+=m;const a=Date.now();a>l+1e3&&(l=a,t.progress(Number((i/c*100).toFixed(2))))}}})))).map(u=>u.offset/t.zoom);return t.progress&&t.progress(100),{async render(u){let d=r;t.zoom!==1&&(d=await Promise.all(e.map(a=>S(a,{...t,zoom:1}))));const m=u.getContext("2d");if(t.direction==="vertical"?(u.width=d[0].width,u.height=d.reduce((a,n)=>a+n.height,0)-o.reduce((a,n)=>a+n,0)):(u.width=d.reduce((a,n)=>a+n.width,0)-o.reduce((a,n)=>a+n,0),u.height=d[0].height),t.sort==="desc"){let a=0;for(let n=0;n<o.length;n++){const h=o[n];n===0&&(U(m,d[n],a,t.direction),a=a+d[n].height),a=a-h,U(m,d[n+1],a,t.direction,[h-t.skipLine]),a=a+d[n+1].height}}else{let a=u.height;for(let n=0;n<o.length;n++){const h=o[n];n===0&&(a=a-d[n].height,U(m,d[n],a,t.direction)),a=a-d[n+1].height+h,U(m,d[n+1],a,t.direction,[0,d[n+1][t.direction==="vertical"?"height":"width"]-h+t.skipLine])}}}}}const Q={components:{PageHeader:C,ImageCon:D,MediaBrowser:T,PreviewScreenshots:A},setup(){const{isGreatOldOne:e}=F();return{isGreatOldOne:e}},data(){return{progress:0,progressStatus:"",startTime:0,endTime:0,canAutoUpdateEnd:!0,formConfig:{labelPosition:"top"},formData:{},fields:[{type:"radio",prop:"pointDiffType",label:"对比方法",required:!0,defaultValue:()=>"gray",options:()=>[{label:"灰度值(推荐，兼顾速度和准确性)",value:"gray"},{label:"色差(速度较慢)",value:"rgb"}]},{type:"switch",label:"使用在线视频",prop:"isUseOnlineVideo",showInForm:()=>this.isGreatOldOne,defaultValue:()=>!1},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"slot",slotName:"tsSelector",needAutoUpdateTime:!0,prop:"start",label:"开始时间",afterSlotName:"screenshots",defaultValue:()=>"00:00:00.0",onChange:(e,t,r)=>{r&&this.canAutoUpdateEnd&&(e.formData.end=e.formData.start)},showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"slot",slotName:"tsSelector",prop:"end",label:"结束时间",afterSlotName:"screenshots",defaultValue:()=>"00:00:00.0",onChange:(e,t,r)=>{r&&(this.canAutoUpdateEnd=!1)},showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"number",prop:"splitCount",label:"分割数量",formProps:{type:"number",min:2},defaultValue:()=>Math.min(10,Math.max(2,navigator.hardwareConcurrency-1)),showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"upload",prop:"images",label:"截图",required:!0,formProps:{listType:"picture-card",multiple:!0},defaultValue:()=>[],rules:[{required:!0,trigger:"submit",validator:(e,t,r)=>{t.length>1?r():r("最少需要两张截图")}}],buttons:[{type:"primary",label:"从视频源生成预览图",show:e=>e.formData.isUseOnlineVideo===!0,handler:e=>this.generateScreenshots(e.formData,"jpg")},{type:"primary",label:"从视频源生成原图",show:e=>e.formData.isUseOnlineVideo===!0,handler:e=>this.generateScreenshots(e.formData,"png")}]},{type:"radio",prop:"direction",label:"截图方向",afterSlotName:"direction-example",required:!0,defaultValue:()=>"vertical-desc",options:[{label:"从上到下",value:"vertical-desc"},{label:"从下到上",value:"vertical-asc"},{label:"从左到右(开发中)",value:"horizontal-desc",disabled:!0},{label:"从右到左(开发中)",value:"horizontal-asc",disabled:!0}]},{type:"number",prop:"skipLine",label:"裁剪边缘",tips:"渲染时去除图像边缘的距离，一定程度上可以去除图像边缘颜色变化的影响。",formProps:{type:"number",min:0},defaultValue:()=>10},{type:"switch",prop:"isUseGrayWeight",label:"调整特定灰度值的权重",tips:"增加局部画面的权重，适用于画面背景和主要画像不是同步移动的时候，增加主要画像的匹配权重",defaultValue:()=>!1},{type:"switch",prop:"isUseGrayWeightReverse",label:"取反",showInForm:!1,keepOnForm:e=>e.formData.isUseGrayWeight,defaultValue:()=>!1},{type:"slot",slotName:"SetGrayWeightBoundary",prop:"grayWeightBoundary",label:"灰度值分界点",tips:"调整至主要画像为蓝色即可",showInForm:e=>e.formData.isUseGrayWeight,defaultValue:()=>100},{type:"radio",prop:"zoom",label:"采样率",tips:"采样率越低，效率越高，采样率过低可能会导致结果不准确。",options:[{label:"10%",value:10},{label:"25%",value:25},{label:"50%",value:50},{label:"75%",value:75},{label:"100%",value:100}],defaultValue:()=>50},{type:"view",prop:"text",hiddenLabel:!0,viewer:()=>`可用线程数: ${navigator.hardwareConcurrency}`}],buttons:[{type:"primary",label:"合成",handler:(e,t)=>e.formInstance.submitForm().then(r=>{const[c,i]=r.direction.split("-");return this.startTime=Date.now(),this.endTime=0,this.progress=0,this.progressStatus="",this.$refs.result.width=0,this.$refs.result.height=0,J(r.images.map(l=>l.raw),{direction:c,pointDiffType:r.pointDiffType,sort:i,skipLine:r.skipLine,zoom:b.divide(r.zoom,100),isUseGrayWeight:r.isUseGrayWeight,SetGrayWeightBoundary:r.SetGrayWeightBoundary,isUseGrayWeightReverse:r.isUseGrayWeightReverse,progress:l=>{this.progress=l}}).then(({render:l})=>new Promise(o=>{this.endTime=Date.now(),setTimeout(()=>{o(l(this.$refs.result).then(()=>{this.progressStatus="success"}))},1e3)})).catch(l=>{throw this.progressStatus="exception",R.error(l==null?void 0:l.message),l})})},{type:"success",label:"下载",show:()=>this.progressStatus==="success",handler:(e,t)=>new Promise(r=>{this.$refs.result.toBlob(i=>{N(i,`${this.getMergeFileName(this.formData.images.map(l=>l.raw))}.png`),r()})})}]}},methods:{async previewGrayWeightBoundary(e){if(e.images.length===0){this.$msgBox.warning("请先选择截图");return}const t=await S(e.images[parseInt(e.images.length/2)].file,{zoom:1}),{imageData:r,width:c,height:i}=t,[l]=e.direction.split("-"),[o=0,u=l==="vertical"?i:c]=[],d=this.$refs.SetGrayWeightBoundaryPreview,m=d.getContext("2d");if(d.width=c,d.height=i,l==="vertical")for(let a=o*c;a<u*c;a++){const n=a*4,h=[r[n],r[n+1],r[n+2],r[n+3]];m.fillStyle=`rgba(${h.join(",")})`;const v=K(...h);e.isUseGrayWeightReverse?m.fillStyle=v>e.grayWeightBoundary?"rgba(255,255,255,255)":"rgba(38, 126, 240,255)":m.fillStyle=v>e.grayWeightBoundary?"rgba(38, 126, 240,255)":"rgba(255,255,255,255)",m.fillRect(a%c,parseInt(a/c),1,1)}},getMergeFileName(e){let t="";for(let r=0;r<e[0].name.length&&!e.some(c=>c.name[r]!==e[0].name[r]);r++)t+=e[0].name[r];return`${t}${["-","_"].includes(t[t.length-1])?"":"-"}merge`},async generateScreenshots(e,t){if(!e.sourcePath){this.$msgBox.warning("请先选择视频源");return}if(!e.start){this.$msgBox.warning("请先选择开始时间");return}if(e.end){const o=_(e.end),u=_(e.start);if(o<=u){this.$msgBox.warning(`结束时间[${o}]不能小于等于开始时间[${u}]`);return}}else{this.$msgBox.warning("请先选择结束时间");return}if(e.splitCount<2){this.$msgBox.warning("分割数量必须大于1");return}const r=_(e.start),c=_(e.end),i=b.divide(b.subtract(c,r),e.splitCount-1),l=new Array(e.splitCount-1).fill(null).map((o,u)=>Number(b.add(r,b.multiply(u,i)).toFixed(2)));l.push(c),e.images=[];for(let o=0;o<l.length;o++){const u=l[o],d=await L(e.sourcePath,u,t),m=`image-${o}.${t}`;e.images.push({name:m,raw:new File([d],m,{type:d.type}),status:"ready",percentage:0,size:d.size,url:URL.createObjectURL(d)})}},previewResult(){this.$refs.result.toBlob(e=>{const t=`${this.getMergeFileName(this.formData.images.map(r=>r.raw))}.png`;this.$imagePreview(URL.createObjectURL(e),{fileName:t})})}}},k=e=>(z("data-v-078ab03a"),e=e(),E(),e),X={class:"page"},Y={class:"direction-example"},Z=k(()=>y("span",null,"示例：",-1)),ee=k(()=>y("span",null,".",-1)),te={class:"SetGrayWeightBoundary-handler"},re={ref:"SetGrayWeightBoundaryPreview",style:{width:"100%","margin-top":"24px",cursor:"pointer"}},ae={style:{"margin-top":"24px"}};function se(e,t,r,c,i,l){const o=p("PageHeader"),u=p("ImageCon"),d=p("MediaBrowser"),m=p("el-time-picker"),a=p("el-input-number"),n=p("PreviewScreenshots"),h=p("el-slider"),v=p("el-switch"),B=p("el-button"),P=p("EasyForm"),G=p("el-progress");return M(),O("div",X,[f(o),f(P,{modelValue:i.formData,"onUpdate:modelValue":t[0]||(t[0]=s=>i.formData=s),fields:i.fields,buttons:i.buttons,"form-config":i.formConfig},{"direction-example":w(s=>[y("div",Y,[Z,f(u,{source:"static",src:`/assets/image-merge-${s.formData[s.field.prop]}-example.png`},null,8,["src"])])]),fileBrowser:w(s=>[f(d,{modelValue:s.formData[s.field.prop],"onUpdate:modelValue":g=>s.formData[s.field.prop]=g,checkMode:"single"},null,8,["modelValue","onUpdate:modelValue"])]),tsSelector:w(s=>[f(m,{"model-value":s.formData[s.field.prop].split(".")[0],"value-format":"HH:mm:ss",format:"HH:mm:ss",style:{width:"120px"},"onUpdate:modelValue":g=>{s.formData[s.field.prop]=`${g||"00:00:00"}.${s.formData[s.field.prop].split(".")[1]}`,s.field.onChange(s,g,!0)}},null,8,["model-value","onUpdate:modelValue"]),ee,f(a,{"model-value":Number("0."+s.formData[s.field.prop].split(".")[1]),min:0,max:1,precision:3,step:.1,style:{width:"120px"},"onUpdate:modelValue":g=>{s.formData[s.field.prop]=`${s.formData[s.field.prop].split(".")[0]}.${String(g).split(".")[1]||0}`,s.field.onChange(s,g,!0)}},null,8,["model-value","step","onUpdate:modelValue"])]),screenshots:w(s=>[f(n,{modelValue:s.formData[s.field.prop],sourcePath:s.formData.sourcePath,"onUpdate:modelValue":g=>{s.formData[s.field.prop]=g,s.field.onChange(s,g,!0)}},null,8,["modelValue","sourcePath","onUpdate:modelValue"])]),SetGrayWeightBoundary:w(s=>[f(h,{modelValue:s.formData[s.field.prop],"onUpdate:modelValue":g=>s.formData[s.field.prop]=g,"show-input":"",max:255},null,8,["modelValue","onUpdate:modelValue"]),y("div",te,[I(" 取反"),f(v,{modelValue:s.formData.isUseGrayWeightReverse,"onUpdate:modelValue":g=>s.formData.isUseGrayWeightReverse=g,"inline-prompt":"","active-text":"是","inactive-text":"否"},null,8,["modelValue","onUpdate:modelValue"]),f(B,{style:{"margin-left":"auto"},onClick:()=>{l.previewGrayWeightBoundary(s.formData)}},{default:w(()=>[I(" 预览 ")]),_:2},1032,["onClick"])]),y("canvas",re,null,512)]),_:1},8,["modelValue","fields","buttons","form-config"]),y("div",ae,[f(G,{percentage:i.progress,"text-inside":!0,"stroke-width":24,status:i.progressStatus,format:s=>!i.progressStatus&&s===100?`成功，用时: ${((i.endTime-i.startTime)/1e3).toFixed(1)}s，canvas渲染结果中`:i.progressStatus==="success"?`成功，用时: ${((i.endTime-i.startTime)/1e3).toFixed(1)}s`:`${s}%`},null,8,["percentage","status","format"]),y("canvas",{ref:"result",style:{width:"100%","margin-top":"24px",cursor:"pointer"},onClick:t[1]||(t[1]=()=>{l.previewResult()})},null,512)])])}const de=$(Q,[["render",se],["__scopeId","data-v-078ab03a"]]);export{de as default};
