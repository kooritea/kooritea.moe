import{P as k}from"./95227df1.js";import{_ as x,A as O,u as F,q as N,aJ as D,aK as _,aE as I,aL as n,a0 as q,ay as V,aM as A,aD as T,b as u,d as m,e as f,p as c,w as h,h as P,f as L,g,l as v,t as y,F as H}from"./assets/index-207a969d.js";import{P as z}from"./8e0cd143.js";import{M as R}from"./f08d8d18.js";const G={components:{PageHeader:k,AsyncButtom:O,MediaBrowser:R,PreviewScreenshots:z},setup(){const{onlineApiBaseURL:e}=F(),{accessKey:r}=N();return{accessKey:r,onlineApiBaseURL:e}},data(){return{previewVideoSrc:"",previewVideoSize:0,needUpdatePreviewVideoSrc:!1,canAutoUpdateEnd:!0,formConfig:{labelPosition:"top"},bangumiOptions:[],editTargetOptions:[],editingProps:[],formData:{},fields:[{type:"switch",label:"编辑模式",prop:"useEditMode",defaultValue:()=>!1,required:!0,dontCheckEdit:!0},{type:"select",label:"编辑目标",prop:"id",showInForm:e=>!!e.formData.useEditMode,required:!0,dontCheckEdit:!0,options:()=>this.editTargetOptions,onCreated:()=>{D().then(e=>{this.editTargetOptions=e.filter(r=>!r.remote&&!r.collections.length).map(r=>({label:r.filepath.slice(1),value:r.id,...r}))})},onChange:(e,r,a)=>{if(a){const i=this.editTargetOptions.find(s=>s.id===r);i&&this.$refs.EasyForm.setFieldValue({bid:i.bid,ep:i.ep,start:_(i.start),end:_(i.end),tags:(i.tags||"").split(","),thumbnail:_(i.start+i.thumbnail)})}},formProps:{remote:!0,filterable:!0,remoteMethod:e=>{D({keyword:e}).then(r=>{this.editTargetOptions=r.filter(a=>!a.remote&&!a.collections.length).map(a=>({label:a.filepath.slice(1),value:a.id,...a}))})}}},{type:"select",prop:"bid",label:"Bangumi Id",formProps:{remote:!0,filterable:!0,remoteMethod:e=>{e&&I(e).then(r=>{this.bangumiOptions=r.map(a=>({label:a.name||a.nname,subLabel:a.nname,value:a.subject}))})}},options:()=>this.bangumiOptions,required:e=>!e.formData.useEditMode||this.editingProps.includes("bid"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("bid")},{type:"number",prop:"ep",label:"集数",formProps:{min:0},required:e=>!e.formData.useEditMode||this.editingProps.includes("ep"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("ep")},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",required:e=>!e.formData.useEditMode||this.editingProps.includes("sourcePath")||this.editingProps.includes("start")||this.editingProps.includes("end"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("sourcePath"),onChange:(e,r,a)=>{this.needUpdatePreviewVideoSrc=!0}},{type:"slot",slotName:"tsSelector",prop:"start",label:"开始时间",afterSlotName:"screenshots",required:e=>!e.formData.useEditMode||this.editingProps.includes("start"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("start"),defaultValue:()=>"00:00:00.0",onChange:(e,r,a)=>{a&&(this.needUpdatePreviewVideoSrc=!0,e.formData.useEditMode||(this.canAutoUpdateEnd&&(this.formData.end=this.formData.start),this.formData.thumbnail=this.formData.start))}},{type:"slot",slotName:"tsSelector",prop:"end",label:"结束时间",afterSlotName:"screenshots",required:e=>!e.formData.useEditMode||this.editingProps.includes("end"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("end"),defaultValue:()=>"00:00:00.0",onChange:(e,r,a)=>{this.needUpdatePreviewVideoSrc=!0,a&&(this.canAutoUpdateEnd=!1)},rules:e=>[{validator:(r,a,i)=>{const s=n(a),p=n(e.formData.start);s<=p?i(`结束时间[${s}]不能小于等于开始时间[${p}]`):i()},trigger:"blur"}]},{type:"slot",slotName:"previewVideo",hiddenLabel:!0,showInForm:e=>!!e.formData.sourcePath&&!!e.formData.start&&!!e.formData.end},{type:"select",prop:"tags",valueSplitChar:",",formProps:{multiple:!0,filterable:!0,allowCreate:!0},createOptionValidator:(e,r)=>{var a;return(a=r==null?void 0:r.startsWith)!=null&&a.call(r,"#")?!0:(this.$message({type:"warning",message:"tag必须为#开头",duration:5e3}),!1)},optionsBaseCode:"VIDEO_TAG",label:"标签",required:e=>e.formData.useEditMode&&this.editingProps.includes("tags"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("tags")},{type:"slot",slotName:"tsSelector",prop:"thumbnail",afterSlotName:"screenshots",formProps:{multiple:!0},label:"封面",rules:e=>[{validator:(r,a,i)=>{const s=n(a),p=n(e.formData.start),b=n(e.formData.end);s===0?i():s<p?i(`封面时间[${s}]不能小于开始时间[${p}]`):s>b?i(`封面时间[${s}]不能大于结束时间[${b}]`):i()},trigger:"submit"}],defaultValue:()=>"00:00:00.0",required:e=>e.formData.useEditMode&&this.editingProps.includes("thumbnail"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("thumbnail")},{type:"number",prop:"previews",formProps:{multiple:!0},label:"预览图",showInForm:e=>!e.formData.useEditMode},{type:"switch",prop:"publish",label:"立即发布",defaultValue:()=>!1,showInForm:e=>!e.formData.useEditMode}],buttons:[{type:"primary",label:"提交",handler:(e,r)=>e.formInstance.submitForm().then(a=>(a.useEditMode?this.editMaterial(e,a):this.createMaterial(e,a)).then(()=>{q.success("提交成功"),e.formInstance.resetFormData(),this.editingProps=[],this.previewVideoSrc="",this.previewVideoSize=0,this.needUpdatePreviewVideoSrc=!1,this.canAutoUpdateEnd=!0}))},{label:"恢复上次数据",handler:(e,r)=>{const a=localStorage.getItem("ryona-last");a&&e.formInstance.resetFormData(JSON.parse(a))}}]}},methods:{previewVideo(){this.needUpdatePreviewVideoSrc=!1;const e=new URL(`${this.onlineApiBaseURL}/video/source/material`);e.searchParams.append("mass-controler-fingerprint",this.accessKey),e.searchParams.append("sourcePath",this.formData.sourcePath),e.searchParams.append("start",this.formData.start),e.searchParams.append("end",this.formData.end),this.previewVideoSrc=e.toString()},createMaterial(e,r){localStorage.setItem("ryona-last",JSON.stringify(r));const a=n(r.start);let i=n(r.thumbnail);i&&(i=Math.max(V.subtract(i,a),0));const s={...r,thumbnail:i};return s.tags||delete s.tags,delete s.useEditMode,A(s)},editMaterial(e,r){const a={};for(const i of this.editingProps)a[i]=r[i];if(a.thumbnail){const i=n(a.thumbnail);this.editingProps.includes("start")?a.thumbnail=Math.max(V.subtract(i,n(a.start)),0):a.thumbnail=Math.max(V.subtract(i,n(r.start)),0)}return T(r.id,a)}}},J={class:"page"},K={class:"label-style"},$={key:0,class:"remarks"},j={key:0,class:"remarks"},W={class:"screenshots-video-box"},Q={class:"controls"},X={key:0,class:"size"},Y={key:1,class:"tips"},Z=["src"];function ee(e,r,a,i,s,p){const b=u("PageHeader"),M=u("el-checkbox"),w=u("MediaBrowser"),S=u("el-time-picker"),E=u("el-input-number"),U=u("PreviewScreenshots"),C=u("AsyncButtom"),B=u("EasyForm");return m(),f("div",J,[c(b),c(B,{ref:"EasyForm",modelValue:s.formData,"onUpdate:modelValue":r[0]||(r[0]=t=>s.formData=t),fields:s.fields,buttons:s.buttons,"form-config":s.formConfig},{label:h(t=>[P("div",K,[t.formData.useEditMode&&!t.getPropValue(t.field.dontCheckEdit)?(m(),L(M,{key:0,"model-value":s.editingProps.includes(t.field.prop),"onUpdate:modelValue":o=>{o?s.editingProps.push(t.field.prop):s.editingProps.splice(s.editingProps.indexOf(t.field.prop),1)}},{default:h(()=>[t.getPropValue(t.field.required)?(m(),f("span",$," * ")):g("",!0),v(" "+y(t.field.label),1)]),_:2},1032,["model-value","onUpdate:modelValue"])):(m(),f(H,{key:1},[t.getPropValue(t.field.required)?(m(),f("span",j," * ")):g("",!0),v(" "+y(t.field.label),1)],64))])]),fileBrowser:h(t=>[c(w,{modelValue:t.formData[t.field.prop],"onUpdate:modelValue":o=>t.formData[t.field.prop]=o,checkMode:"single",disabled:t.disabled},null,8,["modelValue","onUpdate:modelValue","disabled"])]),tsSelector:h(t=>[c(S,{"model-value":t.formData[t.field.prop].split(".")[0],disabled:t.disabled,"value-format":"HH:mm:ss",format:"HH:mm:ss",style:{width:"120px"},"onUpdate:modelValue":o=>{var d,l;t.formData[t.field.prop]=`${o||"00:00:00"}.${t.formData[t.field.prop].split(".")[1]}`,(l=(d=t.field).onChange)==null||l.call(d,t,o,!0)}},null,8,["model-value","disabled","onUpdate:modelValue"]),r[1]||(r[1]=P("span",null,".",-1)),c(E,{disabled:t.disabled,"model-value":Number("0."+t.formData[t.field.prop].split(".")[1]),min:0,max:1,precision:3,step:.1,style:{width:"120px"},"onUpdate:modelValue":o=>{var d,l;t.formData[t.field.prop]=`${t.formData[t.field.prop].split(".")[0]}.${String(o).split(".")[1]||0}`,(l=(d=t.field).onChange)==null||l.call(d,t,o,!0)}},null,8,["disabled","model-value","onUpdate:modelValue"])]),screenshots:h(t=>[c(U,{modelValue:t.formData[t.field.prop],sourcePath:t.formData.sourcePath,"onUpdate:modelValue":o=>{var d,l;t.formData[t.field.prop]=o,(l=(d=t.field)==null?void 0:d.onChange)==null||l.call(d,t,o,!0)}},null,8,["modelValue","sourcePath","onUpdate:modelValue"])]),previewVideo:h(()=>[P("div",W,[P("div",Q,[c(C,{type:"primary",onLoadingClick:()=>p.previewVideo()},{default:h(()=>r[2]||(r[2]=[v(" 预览切片 ")])),_:1},8,["onLoadingClick"]),s.previewVideoSize?(m(),f("div",X,y(s.previewVideoSize)+"MB ",1)):g("",!0),s.needUpdatePreviewVideoSrc?(m(),f("div",Y," 需要更新预览 ")):g("",!0)]),s.previewVideoSrc?(m(),f("video",{key:0,class:"video",controls:"",preload:"none",src:s.previewVideoSrc},null,8,Z)):g("",!0)])]),_:1},8,["modelValue","fields","buttons","form-config"])])}const ie=x(G,[["render",ee],["__scopeId","data-v-3ed88089"]]);export{ie as default};
