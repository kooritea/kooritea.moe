import{_ as P,u as w,q as S,b as l,d as u,f as V,w as m,e as f,g as G,au as b,av as I,Z as R,p as d,h as v,E as x,t as g,F as C,a2 as y,aw as M,ax as T,ay as E,az as F,aA as k,aB as L,aC as $,l as B}from"./assets/index-88e13805.js";import{P as O}from"./8edce4dc.js";const U={setup(){const{onlineApiBaseURL:e}=w(),{accessKey:t}=S();return{accessKey:t,onlineApiBaseURL:e}},data(){return{dialogVisible:!1,sourceSrc:""}},methods:{open({sourceSrc:e}){const t=new URL(`${this.onlineApiBaseURL}${e}`);t.searchParams.append("mass-controler-fingerprint",this.accessKey),this.sourceSrc=t.toString(),this.dialogVisible=!0}}},A=["src"];function H(e,t,r,a,o,n){const i=l("el-dialog");return u(),V(i,{modelValue:o.dialogVisible,"onUpdate:modelValue":t[0]||(t[0]=p=>o.dialogVisible=p),title:"预览"},{default:m(()=>[o.dialogVisible?(u(),f("video",{key:0,class:"video",controls:"",preload:"none",src:o.sourceSrc},null,8,A)):G("",!0)]),_:1},8,["modelValue"])}const D=P(U,[["render",H],["__scopeId","data-v-a814176b"]]);const q={components:{GPPRyonaVideoPreviewDialog:D},data(){return{float:b,dialogVisible:!1,formConfig:{labelPosition:"top"},materials:[],formData:{},fields:[{type:"slot",slotName:"materialsInfo",prop:"materialIds",label:"包含切片",required:!0,formProps:{multiple:!0}},{type:"input",prop:"title",label:"标题",required:!0,options:()=>Array.from(new Set(this.materials.map(e=>{var t;return(t=e.bangumi)==null?void 0:t.nname})))},{type:"select",prop:"thumbnail",label:"封面",required:!0,options:()=>this.materials.map((e,t)=>{if(e.thumbnail===null)return null;const r=e.thumbnail,a=this.materials.slice(0,t).reduce((o,n)=>b.add(o,b.subtract(n.end,n.start)),0);return b.add(r,a)}).filter(e=>e!==null).map(e=>({label:e,value:String(e)}))},{type:"switch",prop:"publish",label:"立即发布",defaultValue:()=>!0}],buttons:[{label:"预览",type:"default",handler:e=>{this.$refs.GPPRyonaVideoPreviewDialog.open({sourceSrc:`/video/source/collection/create/preview?materialIds=${this.materials.map(t=>t.id).join(",")}`})}},{label:"提交",type:"primary",handler:e=>e.formInstance.submitForm().then(t=>I(t).then(()=>{R.success("提交成功"),e.formInstance.resetFormData(),this.dialogVisible=!1}))}]}},methods:{open({materials:e}){this.materials=e,this.formData={materialIds:e.map(t=>t.id)},this.dialogVisible=!0}}},N={class:"materials-info"};function z(e,t,r,a,o,n){const i=l("EasyForm"),p=l("GPPRyonaVideoPreviewDialog"),c=l("el-dialog");return u(),V(c,{modelValue:o.dialogVisible,"onUpdate:modelValue":t[1]||(t[1]=s=>o.dialogVisible=s),title:"创建切片集合"},{default:m(()=>[d(i,{ref:"EasyForm",modelValue:o.formData,"onUpdate:modelValue":t[0]||(t[0]=s=>o.formData=s),fields:o.fields,buttons:o.buttons,"form-config":o.formConfig},{materialsInfo:m(()=>[v("div",N,[(u(!0),f(C,null,x(o.materials,(s,h)=>(u(),f("div",{key:s.id,class:"material"},g(h+1)+"、["+g(o.float.subtract(s.end,s.start))+"s]"+g(s.filepath),1))),128))])]),_:1},8,["modelValue","fields","buttons","form-config"]),d(p,{ref:"GPPRyonaVideoPreviewDialog"},null,512)]),_:1},8,["modelValue"])}const W=P(q,[["render",z],["__scopeId","data-v-85c100d3"]]);const j={components:{PageHeader:O,GPPRyonaCreateGroupDialog:W,GPPRyonaVideoPreviewDialog:D},setup(){const{mobileMode:e}=w();return{mobileMode:e}},data(){return{isExSearch:!1,bangumiOptions:[],tableData:[],selected:[],tableProp:{tableConfig:{handlerWidth:"210px",showPagination:!0,selection:!0,tableProps:{stripe:!0,border:!0},tableHandlerProps:{fixed:void 0},publicTableProps:{showOverflowTooltip:!0},tableSelectionProps:{selectable:e=>!!e.filepath}},emitLoadOnCreate:!0,buttons:[{type:"primary",buttonProps:{link:!0},label:"发布",handler:(e,t)=>{y({title:"提示",message:`确认发布${t.row.filepath}`,type:"warning",confirmHandlerPromise:r=>M(t.row.id).then(()=>{this.$refs.EditTable.search()})})}},{type:"primary",buttonProps:{link:!0},label:"查看",handler:(e,t)=>{this.$refs.GPPRyonaVideoPreviewDialog.open({sourceSrc:`/video/source/material/preview/${t.row.id}`})}},{type:"primary",buttonProps:{link:!0},label:"编辑",handler:(e,t)=>{this.$refs.EditTable.editReady(t.row)}},{type:"danger",buttonProps:{link:!0},label:"删除",handler:(e,t)=>{y({title:"提示",message:`确认删除${t.row.filepath}`,type:"warning",confirmHandlerPromise:r=>T(t.row.id).then(()=>{this.$refs.EditTable.search()})})}}]},searchFormProp:{formConfig:{labelWidth:"100px",labelPosition:"right",gutter:32}},formProp:{formConfig:{selectEditMode:!0,buttonPosition:"right"},buttons:[{type:"primary",label:"提交",handler:(e,t,r)=>e.formInstance.submitForm().then(a=>E(e.formData.id,a))}]},fields:[{type:"select",label:"ID",prop:"id",span:this.mobileMode?24:12,tableProps:{width:60},showInForm:!1},{type:"select",prop:"bid",label:"Bangumi",formProps:{remote:!0,filterable:!0,remoteMethod:e=>{e&&F(e).then(t=>{this.bangumiOptions=t.map(r=>({label:r.name||r.nname,subLabel:r.nname,value:r.subject}))})}},tableProps:{width:250,formatter:(e,t,r)=>{var a,o;return`${e.filepath?"":"[正在上传]"}${((a=e.bangumi)==null?void 0:a.name)||((o=e.bangumi)==null?void 0:o.nname)}`}},showInForm:!0,options:()=>this.bangumiOptions,span:this.mobileMode?24:12},{type:"number",prop:"ep",label:"集数",formProps:{min:0},showInForm:!1,tableProps:{width:80}},{type:"date-picker",prop:"start",label:"开始时间",showInForm:!1,tableProps:{width:120,formatter:(e,t,r)=>this.secondsToTimeString(r)}},{type:"date-picker",prop:"end",label:"结束时间",showInForm:!1,tableProps:{width:120,formatter:(e,t,r)=>this.secondsToTimeString(r)}},{type:"select",prop:"tags",valueSplitChar:",",formProps:{multiple:!0,filterable:!0},span:this.mobileMode?24:12,optionsBaseCode:"VIDEO_TAG",label:"标签"},{type:"buttons",showInTable:!1,showInForm:e=>e.meta.isSearchForm===!0,hiddenLabel:!0,label:"搜索操作",prop:"搜索操作",span:6,formItemProp:{labelWidth:"0px"},buttons:[{label:e=>this.isExSearch?"收起":"展开",leftIcon:e=>this.isExSearch?k:L,type:"primary",buttonProps:{link:!0},handler:e=>{this.isExSearch=!this.isExSearch}},{label:"查询",type:"primary",handler:e=>{const{meta:t}=e,{_editTable:r}=t,{editTableInstance:a}=r;a.search()}},{label:"重置",type:"primary",buttonProps:{plain:!0},handler:e=>{const{meta:t}=e,{_editTable:r}=t,{editTableInstance:a}=r;a.search({reset:!0})}}]}]}},methods:{onLoad(e,t){return $({size:e.size,page:e.current,andLike:{tags:t.tags||void 0},andEqual:{bid:t.bid||void 0}}).then(r=>({tableData:r.records,total:r.total}))},secondsToTimeString(e){e=Math.max(0,e);const t=Math.floor(e%1*1e3),r=Math.floor(e),a=Math.floor(r/3600),o=Math.floor(r%3600/60),n=r%60,i=String(a).padStart(2,"0"),p=String(o).padStart(2,"0"),c=String(n).padStart(2,"0"),s=t>0?"."+String(t).padStart(3,"0"):"";return`${i}:${p}:${c}${s}`}}},K={class:"page"},Z={class:"table-top"};function J(e,t,r,a,o,n){const i=l("PageHeader"),p=l("el-button"),c=l("edit-table"),s=l("GPPRyonaCreateGroupDialog"),h=l("GPPRyonaVideoPreviewDialog");return u(),f("div",K,[d(i),d(c,{ref:"EditTable",modelValue:o.tableData,"onUpdate:modelValue":t[1]||(t[1]=_=>o.tableData=_),selected:o.selected,"onUpdate:selected":t[2]||(t[2]=_=>o.selected=_),"show-search-form":!0,fields:o.fields,"table-prop":o.tableProp,"search-form-prop":o.searchFormProp,"form-prop":o.formProp,"search-loader":n.onLoad},{"table-top":m(()=>[v("div",Z,[d(p,{disabled:o.selected.length<2,type:"primary",onClick:t[0]||(t[0]=()=>{e.$refs.GPPRyonaCreateGroupDialog.open({materials:o.selected})})},{default:m(()=>[B(" 生成集合 ")]),_:1},8,["disabled"])])]),_:1},8,["modelValue","selected","fields","table-prop","search-form-prop","form-prop","search-loader"]),d(s,{ref:"GPPRyonaCreateGroupDialog"},null,512),d(h,{ref:"GPPRyonaVideoPreviewDialog"},null,512)])}const Y=P(j,[["render",J],["__scopeId","data-v-59aaa08f"]]);export{Y as default};
