import{_,aw as m,ax as v,a0 as D,b as s,d as c,f as G,w as b,p as i,h as w,e as g,E as I,t as P,F as S,u as T,a4 as y,ay as C,az as M,aA as x,aB as E,aC as R,aD as F,aE as k,l as O}from"./assets/index-6204cb62.js";import{P as B}from"./4b116bce.js";import{G as V}from"./6c1c4ad3.js";const L={components:{GPPRyonaVideoPreviewDialog:V},data(){return{float:m,dialogVisible:!1,formConfig:{labelPosition:"top"},materials:[],formData:{},fields:[{type:"slot",slotName:"materialsInfo",prop:"materialIds",label:"包含切片",required:!0,formProps:{multiple:!0}},{type:"input",prop:"title",label:"标题",required:!0,options:()=>Array.from(new Set(this.materials.map(e=>{var t;return(t=e.bangumi)==null?void 0:t.nname})))},{type:"select",prop:"thumbnail",label:"封面",required:!0,options:()=>this.materials.map((e,t)=>{if(e.thumbnail===null)return null;const r=e.thumbnail,a=this.materials.slice(0,t).reduce((o,n)=>m.add(o,m.subtract(n.end,n.start)),0);return m.add(r,a)}).filter(e=>e!==null).map(e=>({label:e,value:String(e)}))},{type:"switch",prop:"publish",label:"立即发布",defaultValue:()=>!0}],buttons:[{label:"预览",type:"default",handler:e=>{this.$refs.GPPRyonaVideoPreviewDialog.open({sourceSrc:`/video/source/collection/create/preview?materialIds=${this.materials.map(t=>t.id).join(",")}`})}},{label:"提交",type:"primary",handler:e=>e.formInstance.submitForm().then(t=>v(t).then(()=>{D.success("提交成功"),e.formInstance.resetFormData(),this.dialogVisible=!1}))}]}},methods:{open({materials:e}){this.materials=e,this.formData={materialIds:e.map(t=>t.id)},this.dialogVisible=!0}}},$={class:"materials-info"};function H(e,t,r,a,o,n){const p=s("EasyForm"),d=s("GPPRyonaVideoPreviewDialog"),u=s("el-dialog");return c(),G(u,{modelValue:o.dialogVisible,"onUpdate:modelValue":t[1]||(t[1]=l=>o.dialogVisible=l),title:"创建切片集合"},{default:b(()=>[i(p,{ref:"EasyForm",modelValue:o.formData,"onUpdate:modelValue":t[0]||(t[0]=l=>o.formData=l),fields:o.fields,buttons:o.buttons,"form-config":o.formConfig},{materialsInfo:b(()=>[w("div",$,[(c(!0),g(S,null,I(o.materials,(l,f)=>(c(),g("div",{key:l.id,class:"material"},P(f+1)+"、["+P(o.float.subtract(l.end,l.start))+"s]"+P(l.filepath),1))),128))])]),_:1},8,["modelValue","fields","buttons","form-config"]),i(d,{ref:"GPPRyonaVideoPreviewDialog"},null,512)]),_:1},8,["modelValue"])}const A=_(L,[["render",H],["__scopeId","data-v-85c100d3"]]);const q={components:{PageHeader:B,GPPRyonaCreateGroupDialog:A,GPPRyonaVideoPreviewDialog:V},setup(){const{mobileMode:e}=T();return{mobileMode:e}},data(){return{isExSearch:!1,bangumiOptions:[],tableData:[],selected:[],tableProp:{tableConfig:{handlerWidth:"210px",showPagination:!0,selection:!0,tableProps:{stripe:!0,border:!0},tableHandlerProps:{fixed:void 0},publicTableProps:{showOverflowTooltip:!0},tableSelectionProps:{selectable:e=>!!e.filepath}},emitLoadOnCreate:!0,buttons:[{type:"primary",buttonProps:{link:!0},show:(e,t)=>!t.row.remote,label:"发布",handler:(e,t)=>{y({title:"提示",message:`确认发布${t.row.filepath}`,type:"warning",confirmHandlerPromise:r=>C(t.row.id).then(()=>{this.$refs.EditTable.search()})})}},{type:"primary",buttonProps:{link:!0},label:"查看",handler:(e,t)=>{this.$refs.GPPRyonaVideoPreviewDialog.open({sourceSrc:`/video/source/material/preview/${t.row.id}`})}},{type:"primary",buttonProps:{link:!0},label:"编辑",handler:(e,t)=>{this.$refs.EditTable.editReady(t.row)}},{type:"danger",buttonProps:{link:!0},label:"删除",handler:(e,t)=>{y({title:"提示",message:`确认删除${t.row.filepath}`,type:"warning",confirmHandlerPromise:r=>M(t.row.id).then(()=>{this.$refs.EditTable.search()})})}}]},searchFormProp:{formConfig:{labelWidth:"100px",labelPosition:"right",gutter:32}},formProp:{formConfig:{selectEditMode:!0,buttonPosition:"right"},buttons:[{type:"primary",label:"提交",handler:(e,t,r)=>e.formInstance.submitForm().then(a=>x(e.formData.id,a).then(()=>{this.$refs.EditTable.editConfirm(a)}))}]},fields:[{type:"select",label:"ID",prop:"id",span:this.mobileMode?24:12,tableProps:{width:60},showInForm:!1},{type:"select",prop:"bid",label:"Bangumi",formProps:{remote:!0,filterable:!0,remoteMethod:e=>{e&&E(e).then(t=>{this.bangumiOptions=t.map(r=>({label:r.name||r.nname,subLabel:r.nname,value:r.subject}))})}},tableProps:{width:250,formatter:(e,t,r)=>{var a,o;return`${e.filepath?"":"[正在上传]"}${((a=e.bangumi)==null?void 0:a.name)||((o=e.bangumi)==null?void 0:o.nname)}`}},showInForm:!0,options:()=>this.bangumiOptions,span:this.mobileMode?24:12},{type:"number",prop:"ep",label:"集数",formProps:{min:0},showInForm:!1,tableProps:{width:80}},{type:"date-picker",prop:"start",label:"开始时间",showInForm:!1,tableProps:{width:120,formatter:(e,t,r)=>this.secondsToTimeString(r)}},{type:"date-picker",prop:"end",label:"结束时间",showInForm:!1,tableProps:{width:120,formatter:(e,t,r)=>this.secondsToTimeString(r)}},{type:"select",prop:"tags",valueSplitChar:",",formProps:{multiple:!0,filterable:!0},span:this.mobileMode?24:12,optionsBaseCode:"VIDEO_TAG",label:"标签"},{type:"input",prop:"collections",label:"所在集合",showInForm:!1,tableProps:{width:200,formatter:(e,t,r)=>e.collections.map(a=>`[${a.title}]`).join("")}},{type:"buttons",showInTable:!1,showInForm:e=>e.meta.isSearchForm===!0,hiddenLabel:!0,label:"搜索操作",prop:"搜索操作",span:6,formItemProp:{labelWidth:"0px"},buttons:[{label:e=>this.isExSearch?"收起":"展开",leftIcon:e=>this.isExSearch?R:F,type:"primary",buttonProps:{link:!0},handler:e=>{this.isExSearch=!this.isExSearch}},{label:"查询",type:"primary",handler:e=>{const{meta:t}=e,{_editTable:r}=t,{editTableInstance:a}=r;a.search()}},{label:"重置",type:"primary",buttonProps:{plain:!0},handler:e=>{const{meta:t}=e,{_editTable:r}=t,{editTableInstance:a}=r;a.search({reset:!0})}}]}]}},methods:{onLoad(e,t){return k({size:e.size,page:e.current,andLike:{tags:t.tags||void 0},andEqual:{bid:t.bid||void 0}}).then(r=>({tableData:r.records,total:r.total}))},secondsToTimeString(e){e=Math.max(0,e);const t=Math.floor(e%1*1e3),r=Math.floor(e),a=Math.floor(r/3600),o=Math.floor(r%3600/60),n=r%60,p=String(a).padStart(2,"0"),d=String(o).padStart(2,"0"),u=String(n).padStart(2,"0"),l=t>0?"."+String(t).padStart(3,"0"):"";return`${p}:${d}:${u}${l}`}}},N={class:"page"},U={class:"table-top"};function j(e,t,r,a,o,n){const p=s("PageHeader"),d=s("el-button"),u=s("edit-table"),l=s("GPPRyonaCreateGroupDialog"),f=s("GPPRyonaVideoPreviewDialog");return c(),g("div",N,[i(p),i(u,{ref:"EditTable",modelValue:o.tableData,"onUpdate:modelValue":t[1]||(t[1]=h=>o.tableData=h),selected:o.selected,"onUpdate:selected":t[2]||(t[2]=h=>o.selected=h),"show-search-form":!0,fields:o.fields,"table-prop":o.tableProp,"search-form-prop":o.searchFormProp,"form-prop":o.formProp,"search-loader":n.onLoad},{"table-top":b(()=>[w("div",U,[i(d,{disabled:o.selected.length<2,type:"primary",onClick:t[0]||(t[0]=()=>{e.$refs.GPPRyonaCreateGroupDialog.open({materials:o.selected})})},{default:b(()=>[O(" 生成集合 ")]),_:1},8,["disabled"])])]),_:1},8,["modelValue","selected","fields","table-prop","search-form-prop","form-prop","search-loader"]),i(l,{ref:"GPPRyonaCreateGroupDialog"},null,512),i(f,{ref:"GPPRyonaVideoPreviewDialog"},null,512)])}const K=_(q,[["render",j],["__scopeId","data-v-394b2231"]]);export{K as default};
