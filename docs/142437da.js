import{P as C}from"./ddd14f69.js";import{_ as B,A as k,u as I,q as F,aJ as P,aE as O,aK as p,a0 as x,ay as N,aL as A,aD as q,b as d,d as u,e as f,p as c,w as h,h as b,f as L,g,l as V,t as v,F as H}from"./assets/index-306e3e3a.js";import{P as T}from"./4dee0ab0.js";import{M as z}from"./0c768692.js";const R={components:{PageHeader:C,AsyncButtom:k,MediaBrowser:z,PreviewScreenshots:T},setup(){const{onlineApiBaseURL:e}=I(),{accessKey:r}=F();return{accessKey:r,onlineApiBaseURL:e}},data(){return{previewVideoSrc:"",previewVideoSize:0,needUpdatePreviewVideoSrc:!1,canAutoUpdateEnd:!0,formConfig:{labelPosition:"top"},bangumiOptions:[],editTargetOptions:[],editingProps:[],formData:{},fields:[{type:"switch",label:"编辑模式",prop:"useEditMode",defaultValue:()=>!1,required:!0,dontCheckEdit:!0},{type:"select",label:"编辑目标",prop:"id",showInForm:e=>!!e.formData.useEditMode,required:!0,dontCheckEdit:!0,options:()=>this.editTargetOptions,onCreated:()=>{P().then(e=>{this.editTargetOptions=e.map(r=>({label:r.filepath.slice(1),value:r.id}))})},formProps:{remote:!0,filterable:!0,remoteMethod:e=>{P({keyword:e}).then(r=>{this.editTargetOptions=r.map(a=>({label:a.filepath.slice(1),value:a.id}))})}}},{type:"select",prop:"bid",label:"Bangumi Id",formProps:{remote:!0,filterable:!0,remoteMethod:e=>{e&&O(e).then(r=>{this.bangumiOptions=r.map(a=>({label:a.name||a.nname,subLabel:a.nname,value:a.subject}))})}},options:()=>this.bangumiOptions,required:e=>!e.formData.useEditMode||this.editingProps.includes("bid"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("bid")},{type:"number",prop:"ep",label:"集数",formProps:{min:0},required:e=>!e.formData.useEditMode||this.editingProps.includes("ep"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("ep")},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",required:!0,onChange:(e,r,a)=>{this.needUpdatePreviewVideoSrc=!0},showInForm:e=>!e.formData.useEditMode},{type:"slot",slotName:"tsSelector",prop:"start",label:"开始时间",afterSlotName:"screenshots",required:!0,defaultValue:()=>"00:00:00.0",onChange:(e,r,a)=>{a&&(this.needUpdatePreviewVideoSrc=!0,this.canAutoUpdateEnd&&(this.formData.end=this.formData.start),this.formData.thumbnail=this.formData.start)},showInForm:e=>!e.formData.useEditMode},{type:"slot",slotName:"tsSelector",prop:"end",label:"结束时间",afterSlotName:"screenshots",required:!0,defaultValue:()=>"00:00:00.0",onChange:(e,r,a)=>{this.needUpdatePreviewVideoSrc=!0,a&&(this.canAutoUpdateEnd=!1)},rules:e=>[{validator:(r,a,s)=>{const o=p(a),m=p(e.formData.start);o<=m?s(`结束时间[${o}]不能小于等于开始时间[${m}]`):s()},trigger:"blur"}],showInForm:e=>!e.formData.useEditMode},{type:"slot",slotName:"previewVideo",hiddenLabel:!0,showInForm:e=>!!e.formData.sourcePath&&!!e.formData.start&&!!e.formData.end},{type:"select",prop:"tags",valueSplitChar:",",formProps:{multiple:!0,filterable:!0,allowCreate:!0},createOptionValidator:(e,r)=>{var a;return(a=r==null?void 0:r.startsWith)!=null&&a.call(r,"#")?!0:(this.$message({type:"warning",message:"tag必须为#开头",duration:5e3}),!1)},optionsBaseCode:"VIDEO_TAG",label:"标签",required:e=>e.formData.useEditMode&&this.editingProps.includes("tags"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("tags")},{type:"slot",slotName:"tsSelector",prop:"thumbnail",afterSlotName:"screenshots",formProps:{multiple:!0},label:"封面",rules:e=>[{validator:(r,a,s)=>{const o=p(a),m=p(e.formData.start),_=p(e.formData.end);o===0?s():o<m?s(`封面时间[${o}]不能小于开始时间[${m}]`):o>_?s(`封面时间[${o}]不能大于结束时间[${_}]`):s()},trigger:"submit"}],defaultValue:()=>"00:00:00.0",showInForm:e=>!e.formData.useEditMode},{type:"number",prop:"previews",formProps:{multiple:!0},label:"预览图",showInForm:e=>!e.formData.useEditMode},{type:"switch",prop:"publish",label:"立即发布",defaultValue:()=>!1,showInForm:e=>!e.formData.useEditMode}],buttons:[{type:"primary",label:"提交",handler:(e,r)=>e.formInstance.submitForm().then(a=>(a.useEditMode?this.editMaterial(e,a):this.createMaterial(e,a)).then(()=>{x.success("提交成功"),e.formInstance.resetFormData(),this.editingProps=[],this.previewVideoSrc="",this.previewVideoSize=0,this.needUpdatePreviewVideoSrc=!1,this.canAutoUpdateEnd=!0}))},{label:"恢复上次数据",handler:(e,r)=>{const a=localStorage.getItem("ryona-last");a&&e.formInstance.resetFormData(JSON.parse(a))}}]}},methods:{previewVideo(){this.needUpdatePreviewVideoSrc=!1;const e=new URL(`${this.onlineApiBaseURL}/video/source/material`);e.searchParams.append("mass-controler-fingerprint",this.accessKey),e.searchParams.append("sourcePath",this.formData.sourcePath),e.searchParams.append("start",this.formData.start),e.searchParams.append("end",this.formData.end),this.previewVideoSrc=e.toString()},createMaterial(e,r){localStorage.setItem("ryona-last",JSON.stringify(r));const a=p(r.start);let s=p(r.thumbnail);s&&(s=Math.max(N.subtract(s,a),0));const o={...r,thumbnail:s};return o.tags||delete o.tags,delete o.useEditMode,A(o)},editMaterial(e,r){const a={};for(const s of this.editingProps)a[s]=r[s];return q(r.id,a)}}},G={class:"page"},J={class:"label-style"},K={key:0,class:"remarks"},j={key:0,class:"remarks"},W={class:"screenshots-video-box"},$={class:"controls"},Q={key:0,class:"size"},X={key:1,class:"tips"},Y=["src"];function Z(e,r,a,s,o,m){const _=d("PageHeader"),w=d("el-checkbox"),y=d("MediaBrowser"),D=d("el-time-picker"),S=d("el-input-number"),M=d("PreviewScreenshots"),E=d("AsyncButtom"),U=d("EasyForm");return u(),f("div",G,[c(_),c(U,{modelValue:o.formData,"onUpdate:modelValue":r[0]||(r[0]=t=>o.formData=t),fields:o.fields,buttons:o.buttons,"form-config":o.formConfig},{label:h(t=>[b("div",J,[t.formData.useEditMode&&!t.getPropValue(t.field.dontCheckEdit)?(u(),L(w,{key:0,"model-value":o.editingProps.includes(t.field.prop),"onUpdate:modelValue":i=>{i?o.editingProps.push(t.field.prop):o.editingProps.splice(o.editingProps.indexOf(t.field.prop),1)}},{default:h(()=>[t.getPropValue(t.field.required)?(u(),f("span",K," * ")):g("",!0),V(" "+v(t.field.label),1)]),_:2},1032,["model-value","onUpdate:modelValue"])):(u(),f(H,{key:1},[t.getPropValue(t.field.required)?(u(),f("span",j," * ")):g("",!0),V(" "+v(t.field.label),1)],64))])]),fileBrowser:h(t=>[c(y,{modelValue:t.formData[t.field.prop],"onUpdate:modelValue":i=>t.formData[t.field.prop]=i,checkMode:"single"},null,8,["modelValue","onUpdate:modelValue"])]),tsSelector:h(t=>[c(D,{"model-value":t.formData[t.field.prop].split(".")[0],"value-format":"HH:mm:ss",format:"HH:mm:ss",style:{width:"120px"},"onUpdate:modelValue":i=>{var n,l;t.formData[t.field.prop]=`${i||"00:00:00"}.${t.formData[t.field.prop].split(".")[1]}`,(l=(n=t.field).onChange)==null||l.call(n,t,i,!0)}},null,8,["model-value","onUpdate:modelValue"]),r[1]||(r[1]=b("span",null,".",-1)),c(S,{"model-value":Number("0."+t.formData[t.field.prop].split(".")[1]),min:0,max:1,precision:3,step:.1,style:{width:"120px"},"onUpdate:modelValue":i=>{var n,l;t.formData[t.field.prop]=`${t.formData[t.field.prop].split(".")[0]}.${String(i).split(".")[1]||0}`,(l=(n=t.field).onChange)==null||l.call(n,t,i,!0)}},null,8,["model-value","onUpdate:modelValue"])]),screenshots:h(t=>[c(M,{modelValue:t.formData[t.field.prop],sourcePath:t.formData.sourcePath,"onUpdate:modelValue":i=>{var n,l;t.formData[t.field.prop]=i,(l=(n=t.field)==null?void 0:n.onChange)==null||l.call(n,t,i,!0)}},null,8,["modelValue","sourcePath","onUpdate:modelValue"])]),previewVideo:h(()=>[b("div",W,[b("div",$,[c(E,{type:"primary",onLoadingClick:()=>m.previewVideo()},{default:h(()=>r[2]||(r[2]=[V(" 预览切片 ")])),_:1},8,["onLoadingClick"]),o.previewVideoSize?(u(),f("div",Q,v(o.previewVideoSize)+"MB ",1)):g("",!0),o.needUpdatePreviewVideoSrc?(u(),f("div",X," 需要更新预览 ")):g("",!0)]),o.previewVideoSrc?(u(),f("video",{key:0,class:"video",controls:"",preload:"none",src:o.previewVideoSrc},null,8,Y)):g("",!0)])]),_:1},8,["modelValue","fields","buttons","form-config"])])}const oe=B(R,[["render",Z],["__scopeId","data-v-92a213a9"]]);export{oe as default};
