import{P as C}from"./xBRmIZvY2.js";import{_ as B,A as k,u as F,q as O,aL as w,aM as b,aG as x,aN as o,Z as A,aA as P,aO as I,aF as q,b as l,p as c,w as p,j as m,k as n,f as V,d as N,e as h,l as v,t as M,F as T}from"./assets/index-mGo1r2Sr.js";import{P as L}from"./xBqijSJf2.js";import{M as z}from"./xBAa9iFJd.js";/* empty css         *//* empty css         */import"./xDorDWtH4.js";import"./xDSpHJm7g.js";import"./vander_commonjsHelpers-CqkleIqs.js";import"./xBQkSYhcJ.js";import"./xDeV3HXmH.js";import"./xitWJuOfq.js";import"./xCI3K6sRo.js";import"./xCuTE60Ua.js";import"./vander_baseFindIndex-D7XfJLKM.js";const R={components:{PageHeader:C,AsyncButtom:k,MediaBrowser:z,PreviewScreenshots:L},setup(){const{onlineApiBaseURL:e}=F(),{accessKey:r}=O();return{accessKey:r,onlineApiBaseURL:e}},data(){return{previewVideoSrc:"",previewVideoSize:0,needUpdatePreviewVideoSrc:!1,canAutoUpdateEnd:!0,formConfig:{labelPosition:"top"},bangumiOptions:[],editTargetOptions:[],editingProps:[],formData:{},fields:[{type:"switch",label:"编辑模式",prop:"useEditMode",defaultValue:()=>!1,required:!0,dontCheckEdit:!0},{type:"select",label:"编辑目标",prop:"id",showInForm:e=>!!e.formData.useEditMode,required:!0,dontCheckEdit:!0,options:()=>this.editTargetOptions,onCreated:()=>{w().then(e=>{this.editTargetOptions=e.filter(r=>!r.remote&&!r.collections.length).map(r=>({label:r.filepath.slice(1),value:r.id,...r}))})},onChange:(e,r,t)=>{if(t){const i=this.editTargetOptions.find(s=>s.id===r);i&&this.$refs.EasyForm.setFieldValue({bid:i.bid,ep:i.ep,start:b(i.start),end:b(i.end),tags:(i.tags||"").split(","),thumbnail:b(i.start+i.thumbnail)})}},formProps:{remote:!0,filterable:!0,remoteMethod:e=>{w({keyword:e}).then(r=>{this.editTargetOptions=r.filter(t=>!t.remote&&!t.collections.length).map(t=>({label:t.filepath.slice(1),value:t.id,...t}))})}}},{type:"select",prop:"bid",label:"Bangumi Id",formProps:{remote:!0,filterable:!0,remoteMethod:e=>{e&&x(e).then(r=>{this.bangumiOptions=r.map(t=>({label:t.name||t.nname,subLabel:t.nname,value:t.subject}))})}},options:()=>this.bangumiOptions,required:e=>!e.formData.useEditMode||this.editingProps.includes("bid"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("bid")},{type:"number",prop:"ep",label:"集数",formProps:{min:0},required:e=>!e.formData.useEditMode||this.editingProps.includes("ep"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("ep")},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",required:e=>!e.formData.useEditMode||this.editingProps.includes("sourcePath")||this.editingProps.includes("start")||this.editingProps.includes("end"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("sourcePath"),onChange:(e,r,t)=>{this.needUpdatePreviewVideoSrc=!0}},{type:"slot",slotName:"screenshots",prop:"start",label:"开始时间",required:e=>!e.formData.useEditMode||this.editingProps.includes("start"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("start"),defaultValue:()=>"00:00:00.0",onChange:(e,r,t)=>{t&&(this.needUpdatePreviewVideoSrc=!0,e.formData.useEditMode||(this.canAutoUpdateEnd&&(this.formData.end=this.formData.start),this.formData.thumbnail=this.formData.start))}},{type:"slot",slotName:"screenshots",prop:"end",label:"结束时间",required:e=>!e.formData.useEditMode||this.editingProps.includes("end"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("end"),defaultValue:()=>"00:00:00.0",onChange:(e,r,t)=>{this.needUpdatePreviewVideoSrc=!0,t&&(this.canAutoUpdateEnd=!1)},rules:e=>[{validator:(r,t,i)=>{const s=o(t),d=o(e.formData.start);s<=d?i(`结束时间[${s}]不能小于等于开始时间[${d}]`):i()},trigger:"blur"}]},{type:"slot",slotName:"previewVideo",hiddenLabel:!0,showInForm:e=>!!e.formData.sourcePath&&!!e.formData.start&&!!e.formData.end},{type:"select",prop:"tags",valueSplitChar:",",formProps:{multiple:!0,filterable:!0,allowCreate:!0},createOptionValidator:(e,r)=>{var t;return(t=r==null?void 0:r.startsWith)!=null&&t.call(r,"#")?!0:(this.$message({type:"warning",message:"tag必须为#开头",duration:5e3}),!1)},optionsBaseCode:"VIDEO_TAG",label:"标签",required:e=>e.formData.useEditMode&&this.editingProps.includes("tags"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("tags")},{type:"slot",slotName:"screenshots",prop:"thumbnail",formProps:{multiple:!0},label:"封面",rules:e=>[{validator:(r,t,i)=>{const s=o(t),d=o(e.formData.start),f=o(e.formData.end);s===0?i():s<d?i(`封面时间[${s}]不能小于开始时间[${d}]`):s>f?i(`封面时间[${s}]不能大于结束时间[${f}]`):i()},trigger:"submit"}],defaultValue:()=>"00:00:00.0",required:e=>e.formData.useEditMode&&this.editingProps.includes("thumbnail"),disabled:e=>e.formData.useEditMode&&!this.editingProps.includes("thumbnail")},{type:"number",prop:"previews",formProps:{multiple:!0},label:"预览图",showInForm:e=>!e.formData.useEditMode},{type:"switch",prop:"publish",label:"立即发布",defaultValue:()=>!1,showInForm:e=>!e.formData.useEditMode}],buttons:[{type:"primary",label:"提交",handler:(e,r)=>e.formInstance.submitForm().then(t=>(t.useEditMode?this.editMaterial(e,t):this.createMaterial(e,t)).then(()=>{A.success("提交成功"),e.formInstance.resetFormData(),this.editingProps=[],this.previewVideoSrc="",this.previewVideoSize=0,this.needUpdatePreviewVideoSrc=!1,this.canAutoUpdateEnd=!0}))},{label:"恢复上次数据",handler:(e,r)=>{const t=localStorage.getItem("ryona-last");t&&e.formInstance.resetFormData(JSON.parse(t))}}]}},methods:{previewVideo(){this.needUpdatePreviewVideoSrc=!1;const e=new URL(`${this.onlineApiBaseURL}/video/source/material`);e.searchParams.append("mass-controler-fingerprint",this.accessKey),e.searchParams.append("sourcePath",this.formData.sourcePath),e.searchParams.append("start",this.formData.start),e.searchParams.append("end",this.formData.end),this.previewVideoSrc=e.toString()},createMaterial(e,r){localStorage.setItem("ryona-last",JSON.stringify(r));const t=o(r.start);let i=o(r.thumbnail);i&&(i=Math.max(P.subtract(i,t),0));const s={...r,thumbnail:i};return s.tags||delete s.tags,delete s.useEditMode,I(s)},editMaterial(e,r){const t={};for(const i of this.editingProps)t[i]=r[i];if(t.thumbnail){const i=o(t.thumbnail);this.editingProps.includes("start")?t.thumbnail=Math.max(P.subtract(i,o(t.start)),0):t.thumbnail=Math.max(P.subtract(i,o(r.start)),0)}return q(r.id,t)}}},G={class:"page"},H={class:"label-style"},j={key:0,class:"remarks"},J={key:0,class:"remarks"},K={class:"screenshots-video-box"},W={class:"controls"},Z={key:0,class:"size"},Q={key:1,class:"tips"},X=["src"];function Y(e,r,t,i,s,d){const f=m("PageHeader"),y=m("el-checkbox"),D=m("MediaBrowser"),E=m("PreviewScreenshots"),S=m("AsyncButtom"),U=m("EasyForm");return n(),l("div",G,[c(f),c(U,{ref:"EasyForm",modelValue:s.formData,"onUpdate:modelValue":r[0]||(r[0]=a=>s.formData=a),fields:s.fields,buttons:s.buttons,"form-config":s.formConfig},{label:p(a=>[V("div",H,[a.formData.useEditMode&&!a.getPropValue(a.field.dontCheckEdit)?(n(),N(y,{key:0,"model-value":s.editingProps.includes(a.field.prop),"onUpdate:modelValue":u=>{u?s.editingProps.push(a.field.prop):s.editingProps.splice(s.editingProps.indexOf(a.field.prop),1)}},{default:p(()=>[a.getPropValue(a.field.required)?(n(),l("span",j," * ")):h("",!0),v(" "+M(a.field.label),1)]),_:2},1032,["model-value","onUpdate:modelValue"])):(n(),l(T,{key:1},[a.getPropValue(a.field.required)?(n(),l("span",J," * ")):h("",!0),v(" "+M(a.field.label),1)],64))])]),fileBrowser:p(a=>[c(D,{modelValue:a.formData[a.field.prop],"onUpdate:modelValue":u=>a.formData[a.field.prop]=u,checkMode:"single",disabled:a.disabled},null,8,["modelValue","onUpdate:modelValue","disabled"])]),screenshots:p(a=>[c(E,{modelValue:a.formData[a.field.prop],sourcePath:a.formData.sourcePath,"onUpdate:modelValue":u=>{var g,_;a.formData[a.field.prop]=u,(_=(g=a.field)==null?void 0:g.onChange)==null||_.call(g,a,u,!0)}},null,8,["modelValue","sourcePath","onUpdate:modelValue"])]),previewVideo:p(()=>[V("div",K,[V("div",W,[c(S,{type:"primary",onLoadingClick:()=>d.previewVideo()},{default:p(()=>r[1]||(r[1]=[v(" 预览切片 ")])),_:1},8,["onLoadingClick"]),s.previewVideoSize?(n(),l("div",Z,M(s.previewVideoSize)+"MB ",1)):h("",!0),s.needUpdatePreviewVideoSrc?(n(),l("div",Q," 需要更新预览 ")):h("",!0)]),s.previewVideoSrc?(n(),l("video",{key:0,class:"video",controls:"",preload:"none",src:s.previewVideoSrc},null,8,X)):h("",!0)])]),_:1},8,["modelValue","fields","buttons","form-config"])])}const he=B(R,[["render",Y],["__scopeId","data-v-333bd773"]]);export{he as default};
