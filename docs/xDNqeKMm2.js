import{P as j}from"./xDtlx0tMn.js";import{aC as E,_ as N,A as q,K as J,aD as S,aE as z,aF as R,a0 as I,aG as G,b as L,z as w,f as h,w as v,l as k,j as b,k as P,F as D,B as V,d as H,t as U,e as $}from"./assets/index-DXQWvbVj.js";import{g as T}from"./vander_commonjsHelpers-CqkleIqs.js";var C={exports:{}},W=C.exports,B;function K(){return B||(B=1,function(t,e){(function(i,d){t.exports=d()})(W,function(){function i(n){var s=[];return n.AMapUI&&s.push(d(n.AMapUI)),n.Loca&&s.push(l(n.Loca)),Promise.all(s)}function d(n){return new Promise(function(s,r){var c=[];if(n.plugins)for(var p=0;p<n.plugins.length;p+=1)a.AMapUI.plugins.indexOf(n.plugins[p])==-1&&c.push(n.plugins[p]);if(u.AMapUI===o.failed)r("前次请求 AMapUI 失败");else if(u.AMapUI===o.notload){u.AMapUI=o.loading,a.AMapUI.version=n.version||a.AMapUI.version,p=a.AMapUI.version;var M=document.body||document.head,m=document.createElement("script");m.type="text/javascript",m.src="https://webapi.amap.com/ui/"+p+"/main.js",m.onerror=function(f){u.AMapUI=o.failed,r("请求 AMapUI 失败")},m.onload=function(){if(u.AMapUI=o.loaded,c.length)window.AMapUI.loadUI(c,function(){for(var f=0,A=c.length;f<A;f++){var _=c[f].split("/").slice(-1)[0];window.AMapUI[_]=arguments[f]}for(s();g.AMapUI.length;)g.AMapUI.splice(0,1)[0]()});else for(s();g.AMapUI.length;)g.AMapUI.splice(0,1)[0]()},M.appendChild(m)}else u.AMapUI===o.loaded?n.version&&n.version!==a.AMapUI.version?r("不允许多个版本 AMapUI 混用"):c.length?window.AMapUI.loadUI(c,function(){for(var f=0,A=c.length;f<A;f++){var _=c[f].split("/").slice(-1)[0];window.AMapUI[_]=arguments[f]}s()}):s():n.version&&n.version!==a.AMapUI.version?r("不允许多个版本 AMapUI 混用"):g.AMapUI.push(function(f){f?r(f):c.length?window.AMapUI.loadUI(c,function(){for(var A=0,_=c.length;A<_;A++){var O=c[A].split("/").slice(-1)[0];window.AMapUI[O]=arguments[A]}s()}):s()})})}function l(n){return new Promise(function(s,r){if(u.Loca===o.failed)r("前次请求 Loca 失败");else if(u.Loca===o.notload){u.Loca=o.loading,a.Loca.version=n.version||a.Loca.version;var c=a.Loca.version,p=a.AMap.version.startsWith("2"),M=c.startsWith("2");if(p&&!M||!p&&M)r("JSAPI 与 Loca 版本不对应！！");else{p=a.key,M=document.body||document.head;var m=document.createElement("script");m.type="text/javascript",m.src="https://webapi.amap.com/loca?v="+c+"&key="+p,m.onerror=function(f){u.Loca=o.failed,r("请求 AMapUI 失败")},m.onload=function(){for(u.Loca=o.loaded,s();g.Loca.length;)g.Loca.splice(0,1)[0]()},M.appendChild(m)}}else u.Loca===o.loaded?n.version&&n.version!==a.Loca.version?r("不允许多个版本 Loca 混用"):s():n.version&&n.version!==a.Loca.version?r("不允许多个版本 Loca 混用"):g.Loca.push(function(f){f?r(f):r()})})}if(!window)throw Error("AMap JSAPI can only be used in Browser.");var o;(function(n){n.notload="notload",n.loading="loading",n.loaded="loaded",n.failed="failed"})(o||(o={}));var a={key:"",AMap:{version:"1.4.15",plugins:[]},AMapUI:{version:"1.1",plugins:[]},Loca:{version:"1.3.2"}},u={AMap:o.notload,AMapUI:o.notload,Loca:o.notload},g={AMap:[],AMapUI:[],Loca:[]},y=[],x=function(n){typeof n=="function"&&(u.AMap===o.loaded?n(window.AMap):y.push(n))};return{load:function(n){return new Promise(function(s,r){if(u.AMap==o.failed)r("");else if(u.AMap==o.notload){var c=n.key,p=n.version,M=n.plugins;c?(window.AMap&&location.host!=="lbs.amap.com"&&r("禁止多种API加载方式混用"),a.key=c,a.AMap.version=p||a.AMap.version,a.AMap.plugins=M||a.AMap.plugins,u.AMap=o.loading,p=document.body||document.head,window.___onAPILoaded=function(f){if(delete window.___onAPILoaded,f)u.AMap=o.failed,r(f);else for(u.AMap=o.loaded,i(n).then(function(){s(window.AMap)}).catch(r);y.length;)y.splice(0,1)[0]()},M=document.createElement("script"),M.type="text/javascript",M.src="https://webapi.amap.com/maps?callback=___onAPILoaded&v="+a.AMap.version+"&key="+c+"&plugin="+a.AMap.plugins.join(","),M.onerror=function(f){u.AMap=o.failed,r(f)},p.appendChild(M)):r("请填写key")}else if(u.AMap==o.loaded)if(n.key&&n.key!==a.key)r("多个不一致的 key");else if(n.version&&n.version!==a.AMap.version)r("不允许多个版本 JSAPI 混用");else{if(c=[],n.plugins)for(p=0;p<n.plugins.length;p+=1)a.AMap.plugins.indexOf(n.plugins[p])==-1&&c.push(n.plugins[p]);c.length?window.AMap.plugin(c,function(){i(n).then(function(){s(window.AMap)}).catch(r)}):i(n).then(function(){s(window.AMap)}).catch(r)}else if(n.key&&n.key!==a.key)r("多个不一致的 key");else if(n.version&&n.version!==a.AMap.version)r("不允许多个版本 JSAPI 混用");else{var m=[];if(n.plugins)for(p=0;p<n.plugins.length;p+=1)a.AMap.plugins.indexOf(n.plugins[p])==-1&&m.push(n.plugins[p]);x(function(){m.length?window.AMap.plugin(m,function(){i(n).then(function(){s(window.AMap)}).catch(r)}):i(n).then(function(){s(window.AMap)}).catch(r)})}})},reset:function(){delete window.AMap,delete window.AMapUI,delete window.Loca,a={key:"",AMap:{version:"1.4.15",plugins:[]},AMapUI:{version:"1.1",plugins:[]},Loca:{version:"1.3.2"}},u={AMap:o.notload,AMapUI:o.notload,Loca:o.notload},g={AMap:[],AMapUI:[],Loca:[]}}}})}(C)),C.exports}var Q=K();const X=T(Q);function Y(t,e={}){return new Promise((i,d)=>{t.plugin("AMap.Geolocation",function(){new t.Geolocation({enableHighAccuracy:!0,timeout:1e4,offset:[10,20],zoomToAccuracy:!0,position:"RB",...e}).getCurrentPosition(function(o,a){o==="complete"?i(a):d(a.message)})})})}function Z(t,e,i){return new Promise((d,l)=>{t.convertFrom(e,i,function(o,a){o==="complete"&&a.info==="ok"?d(a.locations):l(a)})})}async function F(t,e,i){const d=[];let l=!1;for(const o of E(e,40)){l&&await new Promise(u=>{setTimeout(()=>{u()},1e3)}),l=!0;const a=await Z(t,o,i);d.push(...a)}return d}function ee(t,e){function i(y){return y*(Math.PI/180)}const d=6371,l=i(e.lat-t.lat),o=i(e.lng-t.lng),a=Math.sin(l/2)*Math.sin(l/2)+Math.cos(i(t.lat))*Math.cos(i(e.lat))*Math.sin(o/2)*Math.sin(o/2),u=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return d*u}const ne={components:{PageHeader:j,AsyncButtom:q,AsyncSwitch:J},data(){return{security:S(z()),AMap:null,parkingData:[],distance:50,activePark:"",isSwitchSelfMarker:!1}},watch:{async parkingData(){const t=await this.AMap;for(const e of Object.values(this.parkingMarkers||{}))e.remove();this.parkingMarkers={};for(const e of this.parkingData){const i=new t.Marker({position:new t.LngLat(e.lng,e.lat),content:'<img src="/assets/park.png" style="width: 28px;">',offset:[-14,-28],extData:e});i.on("click",d=>{var l,o,a;this.activePark=e.parkId,(a=(o=(l=this.$refs[`collapse-${e.parkId}`])==null?void 0:l[0])==null?void 0:o.scrollIntoView)==null||a.call(o,{behavior:"smooth",block:"center",inline:"center"})}),this.map.add(i),this.parkingMarkers[e.parkId]=i}},activePark(){const t=this.parkingData.find(e=>e.parkId===this.activePark);this.map.setCenter([t.lng,t.lat],!0);for(const e of Object.values(this.parkingMarkers||{}))e.setContent('<img src="/assets/park.png" style="width: 28px;">');this.parkingMarkers[t.parkId].setContent('<img src="/assets/park_active.png" style="width: 28px;">'),t.order||(t.order=R({parkId:t.parkId}).then(e=>{t.order=e}))}},created(){let t=null;this.AMap=S(new Promise(e=>{t=e})),this.security.then(e=>{window._AMapSecurityConfig={securityJsCode:e.amapJsCode},t(X.load({key:"ad6be402e09782b82c8fc2bd151ca9a9",version:"2.0",plugins:["AMap.Scale"]}))})},beforeUnmount(){var t;(t=this.map)==null||t.destroy()},mounted(){this.AMap.then(async t=>{let e=await this.getCurrentPosition();e||(I.warning("定位失败"),e={lng:113.835841,lat:22.755457}),this.map=new t.Map("map-container",{zoom:12,center:[e.lng,e.lat]}),this.selfMarker=new t.Marker({content:'<img src="/assets/marker_self.png" style="width: 19px;">',offset:[-9.5,-31],position:new t.LngLat(e.lng,e.lat)}),this.map.add(this.selfMarker),this.getParking(),this.map.on("click",i=>{this.isSwitchSelfMarker&&this.selfMarker.setPosition([i.lnglat.lng,i.lnglat.lat])})})},methods:{async getCurrentPosition(){const t=await this.AMap;let e=await Y(t).then(i=>i.position).catch(i=>(I.warning(`使用高德地图定位失败: ${i}`),null));return e||(navigator.geolocation?e=await new Promise((i,d)=>{navigator.geolocation.getCurrentPosition(l=>{F(t,[l.coords.longitude,l.coords.latitude],"gps").then(o=>{i(o[0])}).catch(o=>{I.warning(`gps转换到高德坐标系失败: ${o}`),d(o)})},l=>{d(l)})}).catch(i=>(I.warning(`使用原生api定位失败: ${i}`),null)):I.warning("你的浏览器不支持地理位置")),e},async setCurrentPosition(){const t=await this.getCurrentPosition();t&&(this.selfMarker.setPosition([t.lng,t.lat]),this.map.setCenter([t.lng,t.lat],!0))},async getParking(){const t=this.selfMarker.getPosition();this.parkingData=await G({lng:t.lng,lat:t.lat,distance:this.distance}).then(async e=>{const i=await F(await this.AMap,e.map(d=>[d.positionX,d.positionY]),"baidu");return e.map((d,l)=>({...d,lng:i[l].lng,lat:i[l].lat,lineDistance:ee(t,{lng:i[l].lng,lat:i[l].lat}).toFixed(2)}))}),this.parkingData.length===0&&I.warning(`范围${this.distance}公里内无可用停车场`)},openOrder(t){window.open(`https://g.qcyuns.com/park-shop/scanQrFixCode?fixCodeId=${t.id}`,"_blank")},gotoAPP(t){window.open(`https://uri.amap.com/marker?position=${t.lng},${t.lat}&coordinate=gaode&callnative=1`,"_blank")}}},te={class:"page"},oe={class:"btn-box"},ae={class:"btn-box"},ie={class:"name"},se={class:"line-distance"},re={class:"remark"},le={key:0,class:"order-list"},ue={class:"shopName"},pe={class:"amount"},ce={class:"btn-box"};function de(t,e,i,d,l,o){const a=b("PageHeader"),u=b("el-input"),g=b("AsyncButtom"),y=b("AsyncSwitch"),x=b("el-collapse-item"),n=b("el-collapse");return P(),L("div",te,[w(a),h("div",oe,[w(u,{modelValue:l.distance,"onUpdate:modelValue":e[0]||(e[0]=s=>l.distance=s)},{append:v(()=>e[3]||(e[3]=[k(" 公里 ")])),_:1},8,["modelValue"]),w(g,{type:"primary",onLoadingClick:()=>o.getParking()},{default:v(()=>e[4]||(e[4]=[k(" 获取当前位置附近停车场 ")])),_:1},8,["onLoadingClick"])]),h("div",ae,[e[6]||(e[6]=k(" 修改当前定位 ")),w(y,{modelValue:l.isSwitchSelfMarker,"onUpdate:modelValue":e[1]||(e[1]=s=>l.isSwitchSelfMarker=s)},null,8,["modelValue"]),w(g,{type:"primary",onLoadingClick:()=>o.setCurrentPosition()},{default:v(()=>e[5]||(e[5]=[k(" 定位 ")])),_:1},8,["onLoadingClick"])]),e[9]||(e[9]=h("div",{id:"map-container"},null,-1)),w(n,{modelValue:l.activePark,"onUpdate:modelValue":e[2]||(e[2]=s=>l.activePark=s),accordion:""},{default:v(()=>[(P(!0),L(D,null,V(l.parkingData,s=>(P(),H(x,{key:s.parkId,name:s.parkId},{title:v(()=>[h("div",{ref_for:!0,ref:`collapse-${s.parkId}`,class:"collapse-title"},[h("div",ie,[k(U(s.parkName)+" ",1),h("span",se," 直线距离: "+U(s.lineDistance)+"公里 ",1)])],512)]),default:v(()=>[h("div",re,[k(U(s.remark)+" ",1),w(g,{type:"primary",size:"mini",onLoadingClick:()=>{o.gotoAPP(s)}},{default:v(()=>e[7]||(e[7]=[k(" 导航 ")])),_:2},1032,["onLoadingClick"])]),Array.isArray(s.order)?(P(),L("div",le,[(P(!0),L(D,null,V(s.order,r=>(P(),L("div",{key:r.id,class:"order"},[h("div",ue,U(r.shopName),1),h("div",pe,U(r.amount),1),h("div",ce,[w(g,{type:"primary",size:"mini",onLoadingClick:()=>{o.openOrder(r)}},{default:v(()=>e[8]||(e[8]=[k(" 打开 ")])),_:2},1032,["onLoadingClick"])])]))),128))])):$("",!0)]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"])])}const Me=N(ne,[["render",de],["__scopeId","data-v-8c04a5a1"]]);export{Me as default};
