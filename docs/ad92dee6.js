import{P as k}from"./900661ab.js";import{I as B}from"./c4f2e7f3.js";import{M as G}from"./1209e150.js";import{_ as T,u as C,az as w,a0 as D,aO as F,aM as _,aP as M,b as h,d as R,e as $,p,w as b,h as y,l as W}from"./assets/index-bfb8b166.js";import{P as O}from"./b7dbd912.js";import{d as L}from"./02b52d33.js";/* empty css        *//* empty css        */import"./6df0fabc.js";import"./b963588d.js";import"./vander_commonjsHelpers-87174ba5.js";import"./d4160b91.js";import"./e9c84fe1.js";import"./ac1fb290.js";import"./c1c5b84c.js";const V=[],x=[];function z(t){let e=V.find(r=>r.WorkerConstructor===t&&!r.running);return!e&&V.length<navigator.hardwareConcurrency-1&&(e={WorkerConstructor:t,worker:new t,running:!1},V.push(e)),e}function I(){if(x.length>0){const t=z(x[0].WorkerConstructor);if(t){const e=x.shift(),r=t.worker;t.running=!0,r.onmessage=function(i){switch(i.data.code){case"result":{e.resolve(i.data.data),t.running=!1,I();break}case"progress":{e.args.progress&&e.args.progress(i.data.data);break}default:e.reject("Unknow Result Code: "+i.data.code)}};const c={...e.args};delete c.progress,r.postMessage(c)}}}function N(t,e){return new Promise((r,c)=>{x.push({WorkerConstructor:t,resolve:r,reject:c,args:e}),I()})}function E(){return new Worker("/assets/worker-4da5cc7c.js")}async function S(t,e){return new Promise((r,c)=>{const i=document.createElement("canvas"),o=i.getContext("2d"),n=new Image;n.onload=async()=>{try{i.width=n.width*e.zoom,i.height=n.height*e.zoom,o.drawImage(n,0,0,n.width,n.height,0,0,i.width,i.height);const l=o.getImageData(0,0,i.width,i.height).data;r({height:i.height,width:i.width,imageData:l})}catch(l){c(l)}},n.src=t instanceof File?URL.createObjectURL(t):t})}function j(t,e,r){return t*6966+e*23436+r*2366>>15}function U(t,e,r,c,i=[]){const{imageData:o,width:n,height:l}=e,[u=0,g=c==="vertical"?l:n]=i;if(c==="vertical")for(let s=u*n;s<g*n;s++){const a=s*4,m=[o[a],o[a+1],o[a+2],o[a+3]];t.fillStyle=`rgba(${m.join(",")})`,t.fillRect(s%n,r+parseInt(s/n),1,1)}}async function A(t,e={}){e={...e,direction:e.direction??"vertical",pointDiffType:e.pointDiffType??"gray",sort:e.sort??"desc",skipLine:e.skipLine??10,zoom:e.zoom??.5};const r=await Promise.all(t.map(l=>S(l,e)));if(Array.from(new Set(r.map(l=>l[e.direction==="vertical"?"width":"height"]))).length>1)throw new Error(`拼接方向为${e.direction==="vertical"?"纵向":"横向"}时所有图片的${e.direction==="vertical"?"宽度":"长度"}必须一致`);const c=r.slice(0,r.length-1).reduce((l,u,g)=>{const s=e.direction==="vertical"?"height":"width",a=Math.min(u[s],r[g+1][s]),m=a*(1+a)/2;return l+m},0);let i=0,o=0;const n=(await Promise.all(r.slice(0,r.length-1).map((l,u)=>N(E,{cmd:"getMaxMatchOffset",data:{image1:r[u],image2:r[u+1],options:{direction:e.direction,pointDiffType:e.pointDiffType,sort:e.sort,isUseGrayWeight:e.isUseGrayWeight,SetGrayWeightBoundary:e.SetGrayWeightBoundary,isUseGrayWeightReverse:e.isUseGrayWeightReverse}},progress:g=>{if(e.progress){i+=g;const s=Date.now();s>o+1e3&&(o=s,e.progress(Number((i/c*100).toFixed(2))))}}})))).map(l=>l.offset/e.zoom);return e.progress&&e.progress(100),{async render(l){let u=r;e.zoom!==1&&(u=await Promise.all(t.map(s=>S(s,{...e,zoom:1}))));const g=l.getContext("2d");if(e.direction==="vertical"?(l.width=u[0].width,l.height=u.reduce((s,a)=>s+a.height,0)-n.reduce((s,a)=>s+a,0)):(l.width=u.reduce((s,a)=>s+a.width,0)-n.reduce((s,a)=>s+a,0),l.height=u[0].height),e.sort==="desc"){let s=0;for(let a=0;a<n.length;a++){const m=n[a];a===0&&(U(g,u[a],s,e.direction),s=s+u[a].height),s=s-m,U(g,u[a+1],s,e.direction,[m-e.skipLine]),s=s+u[a+1].height}}else{let s=l.height;for(let a=0;a<n.length;a++){const m=n[a];a===0&&(s=s-u[a].height,U(g,u[a],s,e.direction)),s=s-u[a+1].height+m,U(g,u[a+1],s,e.direction,[0,u[a+1][e.direction==="vertical"?"height":"width"]-m+e.skipLine])}}}}}const q={components:{PageHeader:k,ImageCon:B,MediaBrowser:G,PreviewScreenshots:O},setup(){const{isGreatOldOne:t}=C();return{isGreatOldOne:t}},data(){return{progress:0,progressStatus:"",startTime:0,endTime:0,canAutoUpdateEnd:!0,formConfig:{labelPosition:"top"},formData:{},fields:[{type:"radio",prop:"pointDiffType",label:"对比方法",required:!0,defaultValue:()=>"gray",options:()=>[{label:"灰度值(推荐，兼顾速度和准确性)",value:"gray"},{label:"色差(速度较慢)",value:"rgb"}]},{type:"switch",label:"使用在线视频",prop:"isUseOnlineVideo",showInForm:()=>this.isGreatOldOne,defaultValue:()=>!1},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",showInForm:t=>t.formData.isUseOnlineVideo===!0},{type:"slot",slotName:"screenshots",needAutoUpdateTime:!0,prop:"start",label:"开始时间",defaultValue:()=>"00:00:00.0",onChange:(t,e,r)=>{r&&this.canAutoUpdateEnd&&(t.formData.end=t.formData.start)},showInForm:t=>t.formData.isUseOnlineVideo===!0},{type:"slot",slotName:"screenshots",prop:"end",label:"结束时间",defaultValue:()=>"00:00:00.0",onChange:(t,e,r)=>{r&&(this.canAutoUpdateEnd=!1)},showInForm:t=>t.formData.isUseOnlineVideo===!0},{type:"number",prop:"splitCount",label:"分割数量",formProps:{type:"number",min:2},defaultValue:()=>Math.min(10,Math.max(2,navigator.hardwareConcurrency-1)),showInForm:t=>t.formData.isUseOnlineVideo===!0},{type:"upload",prop:"images",label:"截图",required:!0,formProps:{listType:"picture-card",multiple:!0},defaultValue:()=>[],rules:[{required:!0,trigger:"submit",validator:(t,e,r)=>{e.length>1?r():r("最少需要两张截图")}}],buttons:[{type:"primary",label:"从视频源生成预览图",show:t=>t.formData.isUseOnlineVideo===!0,handler:t=>this.generateScreenshots(t.formData,"jpg")},{type:"primary",label:"从视频源生成原图",show:t=>t.formData.isUseOnlineVideo===!0,handler:t=>this.generateScreenshots(t.formData,"png")}]},{type:"radio",prop:"direction",label:"截图方向",afterSlotName:"direction-example",required:!0,defaultValue:()=>"vertical-desc",options:[{label:"从上到下",value:"vertical-desc"},{label:"从下到上",value:"vertical-asc"},{label:"从左到右(开发中)",value:"horizontal-desc",disabled:!0},{label:"从右到左(开发中)",value:"horizontal-asc",disabled:!0}]},{type:"number",prop:"skipLine",label:"裁剪边缘",tips:"渲染时去除图像边缘的距离，一定程度上可以去除图像边缘颜色变化的影响。",formProps:{type:"number",min:0},defaultValue:()=>10},{type:"switch",prop:"isUseGrayWeight",label:"调整特定灰度值的权重",tips:"增加局部画面的权重，适用于画面背景和主要画像不是同步移动的时候，增加主要画像的匹配权重",defaultValue:()=>!1},{type:"switch",prop:"isUseGrayWeightReverse",label:"取反",showInForm:!1,keepOnForm:t=>t.formData.isUseGrayWeight,defaultValue:()=>!1},{type:"slot",slotName:"SetGrayWeightBoundary",prop:"grayWeightBoundary",label:"灰度值分界点",tips:"调整至主要画像为蓝色即可",showInForm:t=>t.formData.isUseGrayWeight,defaultValue:()=>100},{type:"radio",prop:"zoom",label:"采样率",tips:"采样率越低，效率越高，采样率过低可能会导致结果不准确。",options:[{label:"10%",value:10},{label:"25%",value:25},{label:"50%",value:50},{label:"75%",value:75},{label:"100%",value:100}],defaultValue:()=>50},{type:"view",prop:"text",hiddenLabel:!0,viewer:()=>`可用线程数: ${navigator.hardwareConcurrency}`}],buttons:[{type:"primary",label:"合成",handler:(t,e)=>t.formInstance.submitForm().then(r=>{const[c,i]=r.direction.split("-");return this.startTime=Date.now(),this.endTime=0,this.progress=0,this.progressStatus="",this.$refs.result.width=0,this.$refs.result.height=0,A(r.images.map(o=>o.raw),{direction:c,pointDiffType:r.pointDiffType,sort:i,skipLine:r.skipLine,zoom:w.divide(r.zoom,100),isUseGrayWeight:r.isUseGrayWeight,SetGrayWeightBoundary:r.SetGrayWeightBoundary,isUseGrayWeightReverse:r.isUseGrayWeightReverse,progress:o=>{this.progress=o}}).then(({render:o})=>new Promise(n=>{this.endTime=Date.now(),setTimeout(()=>{n(o(this.$refs.result).then(()=>{this.progressStatus="success"}))},1e3)})).catch(o=>{throw this.progressStatus="exception",D.error(o==null?void 0:o.message),o})})},{type:"success",label:"下载",show:()=>this.progressStatus==="success",handler:(t,e)=>new Promise(r=>{this.$refs.result.toBlob(i=>{F(i,`${this.getMergeFileName(this.formData.images.map(o=>o.raw))}.png`),r()})})}]}},methods:{async previewGrayWeightBoundary(t){if(t.images.length===0){this.$msgBox.warning("请先选择截图");return}const e=await S(t.images[parseInt(t.images.length/2)].file,{zoom:1}),{imageData:r,width:c,height:i}=e,[o]=t.direction.split("-"),[n=0,l=o==="vertical"?i:c]=[],u=this.$refs.SetGrayWeightBoundaryPreview,g=u.getContext("2d");if(u.width=c,u.height=i,o==="vertical")for(let s=n*c;s<l*c;s++){const a=s*4,m=[r[a],r[a+1],r[a+2],r[a+3]];g.fillStyle=`rgba(${m.join(",")})`;const v=j(...m);t.isUseGrayWeightReverse?g.fillStyle=v>t.grayWeightBoundary?"rgba(255,255,255,255)":"rgba(38, 126, 240,255)":g.fillStyle=v>t.grayWeightBoundary?"rgba(38, 126, 240,255)":"rgba(255,255,255,255)",g.fillRect(s%c,parseInt(s/c),1,1)}},getMergeFileName(t){let e="";for(let r=0;r<t[0].name.length&&!t.some(c=>c.name[r]!==t[0].name[r]);r++)e+=t[0].name[r];return`${L(new Date).format("YYYY-MM-DD").toString()}-${e}${["-","_"].includes(e[e.length-1])?"":"-"}merge`},async generateScreenshots(t,e){if(!t.sourcePath){this.$msgBox.warning("请先选择视频源");return}if(!t.start){this.$msgBox.warning("请先选择开始时间");return}if(t.end){const n=_(t.end),l=_(t.start);if(n<=l){this.$msgBox.warning(`结束时间[${n}]不能小于等于开始时间[${l}]`);return}}else{this.$msgBox.warning("请先选择结束时间");return}if(t.splitCount<2){this.$msgBox.warning("分割数量必须大于1");return}const r=_(t.start),c=_(t.end),i=w.divide(w.subtract(c,r),t.splitCount-1),o=new Array(t.splitCount-1).fill(null).map((n,l)=>Number(w.add(r,w.multiply(l,i)).toFixed(2)));o.push(c),t.images=[];for(let n=0;n<o.length;n++){const l=o[n],u=await M({sourcePath:t.sourcePath,timestamps:l,format:e}),g=`image-${n}.${e}`;t.images.push({name:g,raw:new File([u],g,{type:u.type}),status:"ready",percentage:0,size:u.size,url:URL.createObjectURL(u)})}},previewResult(){this.$refs.result.toBlob(t=>{const e=`${this.getMergeFileName(this.formData.images.map(r=>r.raw))}.png`;this.$imagePreview(URL.createObjectURL(t),{fileName:e})})}}},Y={class:"page"},H={class:"direction-example"},J={class:"SetGrayWeightBoundary-handler"},K={ref:"SetGrayWeightBoundaryPreview",style:{width:"100%","margin-top":"24px",cursor:"pointer"}},Q={style:{"margin-top":"24px"}};function X(t,e,r,c,i,o){const n=h("PageHeader"),l=h("ImageCon"),u=h("MediaBrowser"),g=h("PreviewScreenshots"),s=h("el-slider"),a=h("el-switch"),m=h("el-button"),v=h("EasyForm"),P=h("el-progress");return R(),$("div",Y,[p(n),p(v,{modelValue:i.formData,"onUpdate:modelValue":e[0]||(e[0]=d=>i.formData=d),fields:i.fields,buttons:i.buttons,"form-config":i.formConfig},{"direction-example":b(d=>[y("div",H,[e[2]||(e[2]=y("span",null,"示例：",-1)),p(l,{source:"static",src:`/assets/image-merge-${d.formData[d.field.prop]}-example.png`},null,8,["src"])])]),fileBrowser:b(d=>[p(u,{modelValue:d.formData[d.field.prop],"onUpdate:modelValue":f=>d.formData[d.field.prop]=f,checkMode:"single"},null,8,["modelValue","onUpdate:modelValue"])]),screenshots:b(d=>[p(g,{modelValue:d.formData[d.field.prop],sourcePath:d.formData.sourcePath,"onUpdate:modelValue":f=>{d.formData[d.field.prop]=f,d.field.onChange(d,f,!0)}},null,8,["modelValue","sourcePath","onUpdate:modelValue"])]),SetGrayWeightBoundary:b(d=>[p(s,{modelValue:d.formData[d.field.prop],"onUpdate:modelValue":f=>d.formData[d.field.prop]=f,"show-input":"",max:255},null,8,["modelValue","onUpdate:modelValue"]),y("div",J,[e[4]||(e[4]=W(" 取反")),p(a,{modelValue:d.formData.isUseGrayWeightReverse,"onUpdate:modelValue":f=>d.formData.isUseGrayWeightReverse=f,"inline-prompt":"","active-text":"是","inactive-text":"否"},null,8,["modelValue","onUpdate:modelValue"]),p(m,{style:{"margin-left":"auto"},onClick:()=>{o.previewGrayWeightBoundary(d.formData)}},{default:b(()=>e[3]||(e[3]=[W(" 预览 ")])),_:2},1032,["onClick"])]),y("canvas",K,null,512)]),_:1},8,["modelValue","fields","buttons","form-config"]),y("div",Q,[p(P,{percentage:i.progress,"text-inside":!0,"stroke-width":24,status:i.progressStatus,format:d=>!i.progressStatus&&d===100?`成功，用时: ${((i.endTime-i.startTime)/1e3).toFixed(1)}s，canvas渲染结果中`:i.progressStatus==="success"?`成功，用时: ${((i.endTime-i.startTime)/1e3).toFixed(1)}s`:`${d}%`},null,8,["percentage","status","format"]),y("canvas",{ref:"result",style:{width:"100%","margin-top":"24px",cursor:"pointer"},onClick:e[1]||(e[1]=()=>{o.previewResult()})},null,512)])])}const he=T(q,[["render",X],["__scopeId","data-v-83b76043"]]);export{he as default};
