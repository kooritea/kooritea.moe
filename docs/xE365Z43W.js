import{P as B}from"./xBIr_xQHk.js";import{I as P}from"./xCFUvfJxE.js";import{M as G}from"./xBnIPIzMF.js";import{_ as C,u as T,aJ as w,a3 as D,a$ as R,aW as U,b0 as $,b as F,z as h,w as b,f as y,j as p,k as L,l as _}from"./assets/index-Ci6lRQ3U.js";import{P as M}from"./xDNBO6MTb.js";import{d as O}from"./xDSpHJm7g.js";/* empty css         *//* empty css         */import"./xDlumPUkd.js";import"./xBUXpCyLe.js";import"./vander_commonjsHelpers-CqkleIqs.js";import"./xDJk7YYUq.js";import"./xBW1J9R8p.js";import"./xBI7IVt5R.js";import"./xCVr2HHRa.js";import"./vander_baseFindIndex-D7XfJLKM.js";const W=[],V=[];function z(e){let t=W.find(r=>r.WorkerConstructor===e&&!r.running);return!t&&W.length<navigator.hardwareConcurrency-1&&(t={WorkerConstructor:e,worker:new e,running:!1},W.push(t)),t}function I(){if(V.length>0){const e=z(V[0].WorkerConstructor);if(e){const t=V.shift(),r=e.worker;e.running=!0,r.onmessage=function(i){switch(i.data.code){case"result":{t.resolve(i.data.data),e.running=!1,I();break}case"progress":{t.args.progress&&t.args.progress(i.data.data);break}default:t.reject("Unknow Result Code: "+i.data.code)}};const c={...t.args};delete c.progress,r.postMessage(c)}}}function N(e,t){return new Promise((r,c)=>{V.push({WorkerConstructor:e,resolve:r,reject:c,args:t}),I()})}function j(e){return new Worker(""+new URL("assets/worker-CxcCkurn.js",import.meta.url).href,{name:e==null?void 0:e.name})}async function S(e,t){return new Promise((r,c)=>{const i=document.createElement("canvas"),o=i.getContext("2d"),n=new Image;n.onload=async()=>{try{i.width=n.width*t.zoom,i.height=n.height*t.zoom,o.drawImage(n,0,0,n.width,n.height,0,0,i.width,i.height);const l=o.getImageData(0,0,i.width,i.height).data;r({height:i.height,width:i.width,imageData:l})}catch(l){c(l)}},n.src=e instanceof File?URL.createObjectURL(e):e})}function E(e,t,r){return e*6966+t*23436+r*2366>>15}function x(e,t,r,c,i=[]){const{imageData:o,width:n,height:l}=t,[u=0,m=c==="vertical"?l:n]=i;if(c==="vertical")for(let s=u*n;s<m*n;s++){const a=s*4,g=[o[a],o[a+1],o[a+2],o[a+3]];e.fillStyle=`rgba(${g.join(",")})`,e.fillRect(s%n,r+parseInt(s/n),1,1)}}async function A(e,t={}){t={...t,direction:t.direction??"vertical",pointDiffType:t.pointDiffType??"gray",sort:t.sort??"desc",skipLine:t.skipLine??10,zoom:t.zoom??.5};const r=await Promise.all(e.map(l=>S(l,t)));if(Array.from(new Set(r.map(l=>l[t.direction==="vertical"?"width":"height"]))).length>1)throw new Error(`拼接方向为${t.direction==="vertical"?"纵向":"横向"}时所有图片的${t.direction==="vertical"?"宽度":"长度"}必须一致`);const c=r.slice(0,r.length-1).reduce((l,u,m)=>{const s=t.direction==="vertical"?"height":"width",a=Math.min(u[s],r[m+1][s]),g=a*(1+a)/2;return l+g},0);let i=0,o=0;const n=(await Promise.all(r.slice(0,r.length-1).map((l,u)=>N(j,{cmd:"getMaxMatchOffset",data:{image1:r[u],image2:r[u+1],options:{direction:t.direction,pointDiffType:t.pointDiffType,sort:t.sort,isUseGrayWeight:t.isUseGrayWeight,SetGrayWeightBoundary:t.SetGrayWeightBoundary,isUseGrayWeightReverse:t.isUseGrayWeightReverse}},progress:m=>{if(t.progress){i+=m;const s=Date.now();s>o+1e3&&(o=s,t.progress(Number((i/c*100).toFixed(2))))}}})))).map(l=>l.offset/t.zoom);return t.progress&&t.progress(100),{async render(l){let u=r;t.zoom!==1&&(u=await Promise.all(e.map(s=>S(s,{...t,zoom:1}))));const m=l.getContext("2d");if(t.direction==="vertical"?(l.width=u[0].width,l.height=u.reduce((s,a)=>s+a.height,0)-n.reduce((s,a)=>s+a,0)):(l.width=u.reduce((s,a)=>s+a.width,0)-n.reduce((s,a)=>s+a,0),l.height=u[0].height),t.sort==="desc"){let s=0;for(let a=0;a<n.length;a++){const g=n[a];a===0&&(x(m,u[a],s,t.direction),s=s+u[a].height),s=s-g,x(m,u[a+1],s,t.direction,[g-t.skipLine]),s=s+u[a+1].height}}else{let s=l.height;for(let a=0;a<n.length;a++){const g=n[a];a===0&&(s=s-u[a].height,x(m,u[a],s,t.direction)),s=s-u[a+1].height+g,x(m,u[a+1],s,t.direction,[0,u[a+1][t.direction==="vertical"?"height":"width"]-g+t.skipLine])}}}}}const q={components:{PageHeader:B,ImageCon:P,MediaBrowser:G,PreviewScreenshots:M},setup(){const{isGreatOldOne:e}=T();return{isGreatOldOne:e}},data(){return{progress:0,progressStatus:"",startTime:0,endTime:0,canAutoUpdateEnd:!0,formConfig:{labelPosition:"top"},formData:{},fields:[{type:"radio",prop:"pointDiffType",label:"对比方法",required:!0,defaultValue:()=>"gray",options:()=>[{label:"灰度值(推荐，兼顾速度和准确性)",value:"gray"},{label:"色差(速度较慢)",value:"rgb"}]},{type:"switch",label:"使用在线视频",prop:"isUseOnlineVideo",showInForm:()=>this.isGreatOldOne,defaultValue:()=>!1},{type:"slot",prop:"sourcePath",slotName:"fileBrowser",label:"文件",showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"slot",slotName:"screenshots",needAutoUpdateTime:!0,prop:"start",label:"开始时间",defaultValue:()=>"00:00:00.0",onChange:(e,t,r)=>{r&&this.canAutoUpdateEnd&&(e.formData.end=e.formData.start)},showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"slot",slotName:"screenshots",prop:"end",label:"结束时间",defaultValue:()=>"00:00:00.0",onChange:(e,t,r)=>{r&&(this.canAutoUpdateEnd=!1)},showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"number",prop:"splitCount",label:"分割数量",formProps:{type:"number",min:2},defaultValue:()=>Math.min(10,Math.max(2,navigator.hardwareConcurrency-1)),showInForm:e=>e.formData.isUseOnlineVideo===!0},{type:"upload",prop:"images",label:"截图",required:!0,formProps:{listType:"picture-card",multiple:!0},defaultValue:()=>[],rules:[{required:!0,trigger:"submit",validator:(e,t,r)=>{t.length>1?r():r("最少需要两张截图")}}],buttons:[{type:"primary",label:"从视频源生成预览图",show:e=>e.formData.isUseOnlineVideo===!0,handler:e=>this.generateScreenshots(e.formData,"jpg")},{type:"primary",label:"从视频源生成原图",show:e=>e.formData.isUseOnlineVideo===!0,handler:e=>this.generateScreenshots(e.formData,"png")}]},{type:"radio",prop:"direction",label:"截图方向",afterSlotName:"direction-example",required:!0,defaultValue:()=>"vertical-desc",options:[{label:"从上到下",value:"vertical-desc"},{label:"从下到上",value:"vertical-asc"},{label:"从左到右(开发中)",value:"horizontal-desc",disabled:!0},{label:"从右到左(开发中)",value:"horizontal-asc",disabled:!0}]},{type:"number",prop:"skipLine",label:"裁剪边缘",tips:"渲染时去除图像边缘的距离，一定程度上可以去除图像边缘颜色变化的影响。",formProps:{type:"number",min:0},defaultValue:()=>10},{type:"switch",prop:"isUseGrayWeight",label:"调整特定灰度值的权重",tips:"增加局部画面的权重，适用于画面背景和主要画像不是同步移动的时候，增加主要画像的匹配权重",defaultValue:()=>!1},{type:"switch",prop:"isUseGrayWeightReverse",label:"取反",showInForm:!1,keepOnForm:e=>e.formData.isUseGrayWeight,defaultValue:()=>!1},{type:"slot",slotName:"SetGrayWeightBoundary",prop:"grayWeightBoundary",label:"灰度值分界点",tips:"调整至主要画像为蓝色即可",showInForm:e=>e.formData.isUseGrayWeight,defaultValue:()=>100},{type:"radio",prop:"zoom",label:"采样率",tips:"采样率越低，效率越高，采样率过低可能会导致结果不准确。",options:[{label:"10%",value:10},{label:"25%",value:25},{label:"50%",value:50},{label:"75%",value:75},{label:"100%",value:100}],defaultValue:()=>50},{type:"view",prop:"text",hiddenLabel:!0,viewer:()=>`可用线程数: ${navigator.hardwareConcurrency}`}],buttons:[{type:"primary",label:"合成",handler:(e,t)=>e.formInstance.submitForm().then(r=>{const[c,i]=r.direction.split("-");return this.startTime=Date.now(),this.endTime=0,this.progress=0,this.progressStatus="",this.$refs.result.width=0,this.$refs.result.height=0,A(r.images.map(o=>o.raw),{direction:c,pointDiffType:r.pointDiffType,sort:i,skipLine:r.skipLine,zoom:w.divide(r.zoom,100),isUseGrayWeight:r.isUseGrayWeight,SetGrayWeightBoundary:r.SetGrayWeightBoundary,isUseGrayWeightReverse:r.isUseGrayWeightReverse,progress:o=>{this.progress=o}}).then(({render:o})=>new Promise(n=>{this.endTime=Date.now(),setTimeout(()=>{n(o(this.$refs.result).then(()=>{this.progressStatus="success"}))},1e3)})).catch(o=>{throw this.progressStatus="exception",D.error(o==null?void 0:o.message),o})})},{type:"success",label:"下载",show:()=>this.progressStatus==="success",handler:(e,t)=>new Promise(r=>{this.$refs.result.toBlob(i=>{R(i,`${this.getMergeFileName(this.formData.images.map(o=>o.raw))}.png`),r()})})}]}},methods:{async previewGrayWeightBoundary(e){if(e.images.length===0){this.$msgBox.warning("请先选择截图");return}const t=await S(e.images[parseInt(e.images.length/2)].file,{zoom:1}),{imageData:r,width:c,height:i}=t,[o]=e.direction.split("-"),[n=0,l=o==="vertical"?i:c]=[],u=this.$refs.SetGrayWeightBoundaryPreview,m=u.getContext("2d");if(u.width=c,u.height=i,o==="vertical")for(let s=n*c;s<l*c;s++){const a=s*4,g=[r[a],r[a+1],r[a+2],r[a+3]];m.fillStyle=`rgba(${g.join(",")})`;const v=E(...g);e.isUseGrayWeightReverse?m.fillStyle=v>e.grayWeightBoundary?"rgba(255,255,255,255)":"rgba(38, 126, 240,255)":m.fillStyle=v>e.grayWeightBoundary?"rgba(38, 126, 240,255)":"rgba(255,255,255,255)",m.fillRect(s%c,parseInt(s/c),1,1)}},getMergeFileName(e){let t="";for(let r=0;r<e[0].name.length&&!e.some(c=>c.name[r]!==e[0].name[r]);r++)t+=e[0].name[r];return`${O(new Date).format("YYYY-MM-DD").toString()}-${t}${["-","_"].includes(t[t.length-1])?"":"-"}merge`},async generateScreenshots(e,t){if(!e.sourcePath){this.$msgBox.warning("请先选择视频源");return}if(!e.start){this.$msgBox.warning("请先选择开始时间");return}if(e.end){const n=U(e.end),l=U(e.start);if(n<=l){this.$msgBox.warning(`结束时间[${n}]不能小于等于开始时间[${l}]`);return}}else{this.$msgBox.warning("请先选择结束时间");return}if(e.splitCount<2){this.$msgBox.warning("分割数量必须大于1");return}const r=U(e.start),c=U(e.end),i=w.divide(w.subtract(c,r),e.splitCount-1),o=new Array(e.splitCount-1).fill(null).map((n,l)=>Number(w.add(r,w.multiply(l,i)).toFixed(2)));o.push(c),e.images=[];for(let n=0;n<o.length;n++){const l=o[n],u=await $({sourcePath:e.sourcePath,timestamps:l,format:t}),m=`image-${n}.${t}`;e.images.push({name:m,raw:new File([u],m,{type:u.type}),status:"ready",percentage:0,size:u.size,url:URL.createObjectURL(u)})}},previewResult(){this.$refs.result.toBlob(e=>{const t=`${this.getMergeFileName(this.formData.images.map(r=>r.raw))}.png`;this.$imagePreview(URL.createObjectURL(e),{fileName:t})})}}},Y={class:"page"},H={class:"direction-example"},J={class:"SetGrayWeightBoundary-handler"},K={ref:"SetGrayWeightBoundaryPreview",style:{width:"100%","margin-top":"24px",cursor:"pointer"}},Q={style:{"margin-top":"24px"}};function X(e,t,r,c,i,o){const n=p("PageHeader"),l=p("ImageCon"),u=p("MediaBrowser"),m=p("PreviewScreenshots"),s=p("el-slider"),a=p("el-switch"),g=p("el-button"),v=p("EasyForm"),k=p("el-progress");return L(),F("div",Y,[h(n),h(v,{modelValue:i.formData,"onUpdate:modelValue":t[0]||(t[0]=d=>i.formData=d),fields:i.fields,buttons:i.buttons,"form-config":i.formConfig},{"direction-example":b(d=>[y("div",H,[t[2]||(t[2]=y("span",null,"示例：",-1)),h(l,{source:"static",src:`/assets/image-merge-${d.formData[d.field.prop]}-example.png`},null,8,["src"])])]),fileBrowser:b(d=>[h(u,{modelValue:d.formData[d.field.prop],"onUpdate:modelValue":f=>d.formData[d.field.prop]=f,checkMode:"single"},null,8,["modelValue","onUpdate:modelValue"])]),screenshots:b(d=>[h(m,{modelValue:d.formData[d.field.prop],sourcePath:d.formData.sourcePath,"onUpdate:modelValue":f=>{d.formData[d.field.prop]=f,d.field.onChange(d,f,!0)}},null,8,["modelValue","sourcePath","onUpdate:modelValue"])]),SetGrayWeightBoundary:b(d=>[h(s,{modelValue:d.formData[d.field.prop],"onUpdate:modelValue":f=>d.formData[d.field.prop]=f,"show-input":"",max:255},null,8,["modelValue","onUpdate:modelValue"]),y("div",J,[t[4]||(t[4]=_(" 取反")),h(a,{modelValue:d.formData.isUseGrayWeightReverse,"onUpdate:modelValue":f=>d.formData.isUseGrayWeightReverse=f,"inline-prompt":"","active-text":"是","inactive-text":"否"},null,8,["modelValue","onUpdate:modelValue"]),h(g,{style:{"margin-left":"auto"},onClick:()=>{o.previewGrayWeightBoundary(d.formData)}},{default:b(()=>t[3]||(t[3]=[_(" 预览 ")])),_:2},1032,["onClick"])]),y("canvas",K,null,512)]),_:1},8,["modelValue","fields","buttons","form-config"]),y("div",Q,[h(k,{percentage:i.progress,"text-inside":!0,"stroke-width":24,status:i.progressStatus,format:d=>!i.progressStatus&&d===100?`成功，用时: ${((i.endTime-i.startTime)/1e3).toFixed(1)}s，canvas渲染结果中`:i.progressStatus==="success"?`成功，用时: ${((i.endTime-i.startTime)/1e3).toFixed(1)}s`:`${d}%`},null,8,["percentage","status","format"]),y("canvas",{ref:"result",style:{width:"100%","margin-top":"24px",cursor:"pointer"},onClick:t[1]||(t[1]=()=>{o.previewResult()})},null,512)])])}const pe=C(q,[["render",X],["__scopeId","data-v-83b76043"]]);export{pe as default};
